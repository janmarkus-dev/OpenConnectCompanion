<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenConnect Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Compact calendar with date numbers */
        #contribution-calendar .h-8 {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Hover effects */
        #contribution-calendar .h-8:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .dark #contribution-calendar .h-8:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* Responsive adjustments */
        @media (max-width: 640px) {
            #contribution-calendar .h-8 {
                height: 1.75rem; /* 28px */
                font-size: 0.625rem; /* 10px */
            }
            
            #contribution-calendar .grid {
                gap: 2px;
            }
        }
        
        @media (min-width: 768px) {
            #contribution-calendar .h-8 {
                height: 2.25rem; /* 36px */
                font-size: 0.75rem; /* 12px */
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <div class="min-h-screen bg-gradient-to-b from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-950">
    <header class="bg-white/80 dark:bg-gray-900/60 backdrop-blur-sm shadow-sm border-b border-white/60 dark:border-gray-700/60">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="leading-tight">
                            <span class="block text-2xl sm:text-3xl font-extrabold tracking-tight bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">OpenConnect</span>
                            <span class="mt-0.5 inline-block text-xs sm:text-sm font-medium tracking-wide bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">Companion</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <div class="relative flex space-x-2">
                        <input id="fit-file-upload" name="fit_file" type="file" class="sr-only" accept=".fit" multiple>
                        <label for="fit-file-upload" class="inline-flex items-center px-3 py-2 border border-white/60 dark:border-gray-700/60 text-sm font-medium rounded-md text-gray-800 dark:text-gray-200 bg-white/70 dark:bg-gray-900/50 hover:bg-white/80 dark:hover:bg-gray-800/60 transition-colors duration-200 cursor-pointer backdrop-blur-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Upload Files
                        </label>
                        
                        <input id="fit-folder-upload" name="fit_folder" type="file" class="sr-only" webkitdirectory multiple>
                        <label for="fit-folder-upload" class="inline-flex items-center px-3 py-2 border border-white/60 dark:border-gray-700/60 text-sm font-medium rounded-md text-gray-800 dark:text-gray-200 bg-white/70 dark:bg-gray-900/50 hover:bg-white/80 dark:hover:bg-gray-800/60 transition-colors duration-200 cursor-pointer backdrop-blur-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                            </svg>
                            Upload Folder
                        </label>
                    </div>
                    
                    <button id="garmin-upload-btn" class="inline-flex items-center px-3 py-2 border border-orange-300/70 dark:border-orange-600/70 text-sm font-medium rounded-md text-orange-700 dark:text-orange-300 bg-orange-50/70 dark:bg-orange-900/20 hover:bg-orange-100/80 dark:hover:bg-orange-900/40 transition-colors duration-200 backdrop-blur-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill="currentColor" d="M4.308 13.5q-.214 0-.357-.143q-.143-.144-.143-.357V8q0-.213.143-.357q.143-.143.357-.143q.213 0 .356.143q.144.144.144.357v5q0 .213-.144.357q-.143.143-.356.143Zm15.384 3q-.213 0-.356-.143q-.144-.144-.144-.357v-5q0-.213.144-.357q.143-.143.356-.143q.214 0 .357.143q.143.144.143.357v5q0 .213-.143.357q-.143.143-.357.143ZM8.423 21q-.69 0-1.153-.463q-.462-.462-.462-1.152V4.615q0-.69.462-1.153Q7.733 3 8.423 3h7.154q.69 0 1.153.463q.462.462.462 1.152v14.77q0 .69-.462 1.152q-.463.463-1.153.463H8.423Zm7.77-2.5H7.807v.885q0 .23.192.423q.192.192.423.192h7.154q.23 0 .423-.192q.192-.193.192-.423V18.5Zm-8.385-13h8.384v-.885q0-.23-.192-.423Q15.808 4 15.577 4H8.423q-.23 0-.423.192q-.192.193-.192.423V5.5Zm0 0V4v1.5Zm0 13V20v-1.5Zm0-1h8.384v-11H7.808v11Z"/></svg>
                        Sync Device 
                    </button>
                    
                <button 
                    id="theme-toggle" 
                    class="p-2 rounded-lg border border-gray-200/60 dark:border-gray-700/60 bg-white/70 dark:bg-gray-900/50 hover:bg-white/80 dark:hover:bg-gray-800/60 transition-colors duration-200 backdrop-blur-sm"
                    aria-label="Toggle theme"
                >
                    <svg id="sun-icon" class="w-5 h-5 text-gray-600 dark:text-gray-300 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <svg id="moon-icon" class="w-5 h-5 text-gray-600 dark:text-gray-300 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <div class="rounded-2xl mb-6">
                <div class="p-[1px] rounded-2xl bg-gradient-to-r from-gray-200/60 via-gray-100/40 to-gray-200/60 dark:from-gray-700/60 dark:via-gray-800/60 dark:to-gray-700/60">
                    <div class="rounded-[15px] p-4 bg-white/80 dark:bg-gray-900/50 backdrop-blur-sm">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-9 h-9 rounded-md bg-indigo-500/10 border border-indigo-200/60 dark:border-indigo-800/60 text-indigo-600 dark:text-indigo-300 flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-4">
                                <h2 class="text-lg font-medium text-gray-900 dark:text-white">
                                    Garmin Data Synchronization
                                </h2>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    Blazing fast, open source, local, self-hostable Garmin Connect alternative
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rounded-2xl mb-6"></div>
                <div class="p-[1px] rounded-2xl bg-gradient-to-r from-blue-200/60 via-sky-200/60 to-emerald-200/60 dark:from-gray-700/70 dark:via-gray-800/70 dark:to-gray-700/70">
                    <div class="px-4 py-3 rounded-[15px] bg-white/80 dark:bg-gray-900/40 backdrop-blur-sm">
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex items-center gap-2 min-w-[160px]">
                                <div class="w-7 h-7 rounded-md bg-indigo-500/10 border border-indigo-200/60 dark:border-indigo-800/60 text-indigo-600 dark:text-indigo-300 flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3M5 11h14M5 19h14M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z"/></svg>
                                </div>
                                <div>
                                    <p class="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400">This Month</p>
                                    <p id="month-range" class="text-sm font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">-</p>
                                </div>
                            </div>

                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 rounded-md bg-blue-500/10 border border-blue-200/60 dark:border-blue-800/60 text-blue-600 dark:text-blue-300 flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18M13 13v5M9 9v9M17 7v11"/></svg>
                                </div>
                                <div>
                                    <p class="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400">Workouts</p>
                                    <p id="monthly-workouts" class="text-sm font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">0</p>
                                </div>
                            </div>

                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 rounded-md bg-emerald-500/10 border border-emerald-200/60 dark:border-emerald-800/60 text-emerald-600 dark:text-emerald-300 flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="9" r="4" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22s8-4.5 8-12a8 8 0 10-16 0c0 7.5 8 12 8 12z"/></svg>
                                </div>
                                <div>
                                    <p class="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400">Distance</p>
                                    <p id="monthly-distance" class="text-sm font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">0 km</p>
                                </div>
                            </div>

                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 rounded-md bg-amber-500/10 border border-amber-200/60 dark:border-amber-800/60 text-amber-600 dark:text-amber-300 flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </div>
                                <div>
                                    <p class="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400">Duration</p>
                                    <p id="monthly-duration" class="text-sm font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">0m</p>
                                </div>
                            </div>

                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 rounded-md bg-rose-500/10 border border-rose-200/60 dark:border-rose-800/60 text-rose-600 dark:text-rose-300 flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                </div>
                                <div>
                                    <p class="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400">Calories</p>
                                    <p id="monthly-calories" class="text-sm font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">0 kcal</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rounded-2xl mb-6">
                <div class="p-[1px] rounded-2xl bg-gradient-to-r from-green-200/60 via-emerald-200/60 to-green-200/60 dark:from-gray-700/70 dark:via-gray-800/70 dark:to-gray-700/70">
                    <div class="rounded-[15px] p-4 bg-white/80 dark:bg-gray-900/50 backdrop-blur-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-md bg-green-500/10 border border-green-200/60 dark:border-green-800/60 text-green-600 dark:text-green-300 flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Monthly Activity Calendar</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400" id="calendar-subtitle">Click on any day to view workouts</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-center">
                                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Current Streak</p>
                                    <p id="current-streak" class="text-lg font-bold text-green-600 dark:text-green-400">0 days</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Active Days</p>
                                    <p id="active-days" class="text-lg font-bold text-emerald-600 dark:text-emerald-400">0 days</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="relative">
                            <div class="grid grid-cols-7 gap-1 mb-2 text-xs text-gray-500 dark:text-gray-400">
                                <div class="text-center py-1 font-medium">Sun</div>
                                <div class="text-center py-1 font-medium">Mon</div>
                                <div class="text-center py-1 font-medium">Tue</div>
                                <div class="text-center py-1 font-medium">Wed</div>
                                <div class="text-center py-1 font-medium">Thu</div>
                                <div class="text-center py-1 font-medium">Fri</div>
                                <div class="text-center py-1 font-medium">Sat</div>
                            </div>

                            <div id="contribution-calendar" class="w-full">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rounded-2xl">
                <div class="p-[1px] rounded-2xl bg-gradient-to-r from-gray-200/60 via-gray-100/40 to-gray-200/60 dark:from-gray-700/60 dark:via-gray-800/60 dark:to-gray-700/60">
                    <div class="rounded-[15px] p-4 bg-white/80 dark:bg-gray-900/50 backdrop-blur-sm">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Recent Workouts</h3>
                        <button id="refresh-workouts" class="text-primary-600 hover:text-primary-700 text-sm font-medium">Refresh</button>
                    </div>
                    <div class="mb-4 flex flex-wrap items-center gap-2">
                        <span class="text-xs text-gray-500 dark:text-gray-400">Filter by tags:</span>
                        <div id="tag-filter-chips" class="flex flex-wrap gap-2"></div>
                    </div>
                    
                    <div id="upload-status" class="hidden mb-4 p-3 rounded-md text-sm"></div>
                    
                    <div id="file-list" class="hidden mb-4">
                        <div class="p-[1px] rounded-xl bg-gradient-to-r from-gray-200/60 via-gray-100/40 to-gray-200/60 dark:from-gray-700/60 dark:via-gray-800/60 dark:to-gray-700/60">
                            <div class="rounded-[12px] p-3 bg-white/80 dark:bg-gray-900/50 backdrop-blur-sm border border-white/60 dark:border-gray-700/60">
                                <div class="flex items-center mb-2">
                                    <div class="w-6 h-6 rounded-md bg-primary-500/10 border border-primary-500/30 dark:border-primary-600/40 text-primary-600 dark:text-primary-400 flex items-center justify-center mr-2">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                    </div>
                                    <h4 class="text-sm font-medium bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">Selected FIT Files</h4>
                                    <button id="upload-btn" class="ml-auto inline-flex items-center px-3 py-1.5 border border-primary-500/30 dark:border-primary-600/40 text-xs font-semibold rounded-md text-primary-700 dark:text-primary-300 bg-white/80 dark:bg-gray-900/50 hover:bg-primary-50/80 dark:hover:bg-gray-800/60 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200">
                                        <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                        </svg>
                                        Upload
                                    </button>
                                </div>
                                <ul id="selected-files" class="space-y-1 text-sm"></ul>
                            </div>
                        </div>
                    </div>
                    
                    <div id="workouts-list" class="space-y-2">
                        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                            Loading workouts...
                        </div>
                    </div>
                    
                    <div id="pagination-controls" class="hidden mt-4 flex items-center justify-between border-t border-gray-200/60 dark:border-gray-700/60 pt-4">
                        <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                            <span id="pagination-info">Showing 1-15 of 0 workouts</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button 
                                id="prev-page" 
                                class="px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 bg-white/80 dark:bg-gray-800/60 border border-gray-200/60 dark:border-gray-700/60 rounded-md hover:bg-gray-50/80 dark:hover:bg-gray-700/60 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
                                disabled
                            >
                                Previous
                            </button>
                            <div class="flex items-center space-x-1" id="page-numbers">
                            </div>
                            <button 
                                id="next-page" 
                                class="px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 bg-white/80 dark:bg-gray-800/60 border border-gray-200/60 dark:border-gray-700/60 rounded-md hover:bg-gray-50/80 dark:hover:bg-gray-700/60 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
                                disabled
                            >
                                Next
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="workout-modal" class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm overflow-y-auto h-full w-full z-50">
        <div class="relative top-8 mx-auto p-4 md:p-5 border w-11/12 md:w-5/6 lg:w-4/5 xl:w-3/4 2xl:w-2/3 shadow-xl rounded-2xl bg-white/90 dark:bg-gray-900/70 border-white/60 dark:border-gray-700/60 max-w-6xl">
            <div class="flex items-center justify-between pb-3 border-b border-gray-200/60 dark:border-gray-700/60">
                <h3 id="modal-title" class="text-base md:text-lg font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">Workout Details</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="modal-content" class="pt-3 max-h-[80vh] overflow-y-auto relative">
                <div id="modal-loading" class="absolute inset-0 bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm flex flex-col items-center justify-center z-50 rounded-lg">
                    <div class="relative">
                        <svg class="animate-spin w-12 h-12 text-primary-600" fill="none" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                            <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path>
                        </svg>
                    </div>
                    <div class="mt-4 text-center">
                        <p class="text-lg font-medium text-gray-700 dark:text-gray-300">Loading workout details...</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Preparing charts and maps</p>
                    </div>
                </div>
                
                <section id="route-map-section" class="mb-6 hidden">
                    <div class="relative rounded-xl border border-gray-200/60 dark:border-gray-700/60 overflow-hidden">
                        <div id="route-map-container" class="relative h-48 md:h-64 bg-gray-100 dark:bg-gray-700">
                            <iframe id="route-map-iframe" title="Route Map" class="w-full h-full block" src="about:blank" loading="lazy"></iframe>
                            
                            <div id="route-map-fade" class="pointer-events-none absolute inset-x-0 bottom-0 h-16 bg-gradient-to-t from-white/90 via-white/60 to-transparent dark:from-gray-800/90 dark:via-gray-800/60 transition-opacity"></div>
                            
                            <button id="toggle-map-size" class="absolute bottom-3 right-3 inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md bg-white/90 dark:bg-gray-900/70 text-gray-800 dark:text-gray-200 border border-gray-200 dark:border-gray-700 shadow-sm backdrop-blur hover:bg-white dark:hover:bg-gray-800 transition">
                                <svg id="toggle-icon" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14m-7-7h14"/></svg>
                                <span id="toggle-map-label">Expand map</span>
                            </button>
                        </div>
                    </div>
                </section>
                
                <div id="modal-workout-data" class="hidden">
                    <div class="mb-4">
                        <h4 class="text-sm md:text-md font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2">Basic Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="bg-white/70 dark:bg-gray-800/40 p-2 rounded-md border border-gray-200/60 dark:border-gray-700/60">
                                <span class="block text-xs font-medium text-gray-500 dark:text-gray-400">Activity Type</span>
                                <span id="detail-workout-type" class="text-sm font-semibold text-gray-900 dark:text-white">-</span>
                            </div>
                            <div class="bg-white/70 dark:bg-gray-800/40 p-2 rounded-md border border-gray-200/60 dark:border-gray-700/60">
                                <span class="block text-xs font-medium text-gray-500 dark:text-gray-400">Start Time</span>
                                <span id="detail-start-time" class="text-sm font-semibold text-gray-900 dark:text-white">-</span>
                            </div>
                            <div class="bg-white/70 dark:bg-gray-800/40 p-2 rounded-md border border-gray-200/60 dark:border-gray-700/60">
                                <span class="block text-xs font-medium text-gray-500 dark:text-gray-400">Duration</span>
                                <span id="detail-duration" class="text-sm font-semibold text-gray-900 dark:text-white">-</span>
                            </div>
                            <div class="bg-white/70 dark:bg-gray-800/40 p-2 rounded-md border border-gray-200/60 dark:border-gray-700/60">
                                <span class="block text-xs font-medium text-gray-500 dark:text-gray-400">Distance</span>
                                <span id="detail-distance" class="text-sm font-semibold text-gray-900 dark:text-white">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h4 class="text-sm md:text-md font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2">Performance Metrics</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <div class="p-2 rounded-md border border-red-200/60 dark:border-red-800/60 bg-gradient-to-br from-white/85 to-red-50/60 dark:from-gray-900/30 dark:to-red-900/10">
                                <div class="flex items-center mb-2">
                                    <svg class="w-4 h-4 text-red-600 dark:text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-xs font-medium text-red-700 dark:text-red-300">Heart Rate</span>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex justify-between text-xs">
                                        <span class="text-red-600 dark:text-red-400">Avg:</span>
                                        <span id="detail-hr-avg" class="font-semibold text-red-900 dark:text-red-100">-</span>
                                    </div>
                                    <div class="flex justify-between text-xs">
                                        <span class="text-red-600 dark:text-red-400">Max:</span>
                                        <span id="detail-hr-max" class="font-semibold text-red-900 dark:text-red-100">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="power-metrics-container" class="p-2 rounded-md border border-yellow-200/60 dark:border-yellow-800/60 bg-gradient-to-br from-white/85 to-yellow-50/60 dark:from-gray-900/30 dark:to-yellow-900/10">
                                <div class="flex items-center mb-2">
                                    <svg class="w-4 h-4 text-yellow-600 dark:text-yellow-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    <span class="text-xs font-medium text-yellow-700 dark:text-yellow-300">Power</span>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex justify-between text-xs">
                                        <span class="text-yellow-600 dark:text-yellow-400">Avg:</span>
                                        <span id="detail-power-avg" class="font-semibold text-yellow-900 dark:text-yellow-100">-</span>
                                    </div>
                                    <div class="flex justify-between text-xs">
                                        <span class="text-yellow-600 dark:text-yellow-400">Max:</span>
                                        <span id="detail-power-max" class="font-semibold text-yellow-900 dark:text-yellow-100">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="cadence-metrics-container" class="p-2 rounded-md border border-blue-200/60 dark:border-blue-800/60 bg-gradient-to-br from-white/85 to-blue-50/60 dark:from-gray-900/30 dark:to-blue-900/10">
                                <div class="flex items-center mb-2">
                                    <svg class="w-4 h-4 text-blue-600 dark:text-blue-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    <span class="text-xs font-medium text-blue-700 dark:text-blue-300">Cadence</span>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex justify-between text-xs">
                                        <span class="text-blue-600 dark:text-blue-400">Avg:</span>
                                        <span id="detail-cadence-avg" class="font-semibold text-blue-900 dark:text-blue-100">-</span>
                                    </div>
                                    <div class="flex justify-between text-xs">
                                        <span class="text-blue-600 dark:text-blue-400">Max:</span>
                                        <span id="detail-cadence-max" class="font-semibold text-blue-900 dark:text-blue-100">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-2 rounded-md border border-green-200/60 dark:border-green-800/60 bg-gradient-to-br from-white/85 to-green-50/60 dark:from-gray-900/30 dark:to-green-900/10">
                                <div class="flex items-center mb-2">
                                    <svg class="w-4 h-4 text-green-600 dark:text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="text-xs font-medium text-green-700 dark:text-green-300">Speed</span>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex justify-between text-xs">
                                        <span class="text-green-600 dark:text-green-400">Avg:</span>
                                        <span id="detail-speed-avg" class="font-semibold text-green-900 dark:text-green-100">-</span>
                                    </div>
                                    <div class="flex justify-between text-xs">
                                        <span class="text-green-600 dark:text-green-400">Max:</span>
                                        <span id="detail-speed-max" class="font-semibold text-green-900 dark:text-green-100">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-2 rounded-md border border-purple-200/60 dark:border-purple-800/60 bg-gradient-to-br from-white/85 to-purple-50/60 dark:from-gray-900/30 dark:to-purple-900/10">
                                <div class="flex items-center mb-2">
                                    <svg class="w-4 h-4 text-purple-600 dark:text-purple-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path>
                                    </svg>
                                    <span class="text-xs font-medium text-purple-700 dark:text-purple-300">Calories</span>
                                </div>
                                <div class="text-center">
                                    <span id="detail-calories" class="text-lg font-semibold text-purple-900 dark:text-purple-100">-</span>
                                </div>
                            </div>
                            
                            <div class="p-2 rounded-md border border-gray-200/60 dark:border-gray-600/60 bg-gradient-to-br from-white/85 to-gray-50/60 dark:from-gray-900/30 dark:to-gray-800/20">
                                <div class="flex items-center mb-2">
                                    <svg class="w-4 h-4 text-gray-600 dark:text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                    </svg>
                                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Elevation</span>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex justify-between text-xs">
                                        <span class="text-gray-600 dark:text-gray-400">Gain:</span>
                                        <span id="detail-elevation-gain" class="font-semibold text-gray-900 dark:text-gray-100">-</span>
                                    </div>
                                    <div class="flex justify-between text-xs">
                                        <span class="text-gray-600 dark:text-gray-400">Loss:</span>
                                        <span id="detail-elevation-loss" class="font-semibold text-gray-900 dark:text-gray-100">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h4 class="text-sm md:text-md font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2">Performance Charts</h4>
                        
                        <div id="charts-container">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div class="bg-white/80 dark:bg-gray-900/40 border border-gray-200/60 dark:border-gray-700/60 rounded-lg p-3 shadow-sm">
                                    <h5 class="text-sm font-medium bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2 flex items-center">
                                        <svg class="w-4 h-4 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
                                        </svg>
                                        Heart Rate (bpm)
                                    </h5>
                                    <div class="h-48">
                                        <canvas id="heart-rate-chart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="bg-white/80 dark:bg-gray-900/40 border border-gray-200/60 dark:border-gray-700/60 rounded-lg p-3 shadow-sm">
                                    <h5 class="text-sm font-medium bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2 flex items-center">
                                        <svg class="w-4 h-4 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Speed (km/h)
                                    </h5>
                                    <div class="h-48">
                                        <canvas id="speed-chart"></canvas>
                                    </div>
                                </div>
                                
                                <div id="power-chart-container" class="bg-white/80 dark:bg-gray-900/40 border border-gray-200/60 dark:border-gray-700/60 rounded-lg p-3 shadow-sm">
                                    <h5 class="text-sm font-medium bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2 flex items-center">
                                        <svg class="w-4 h-4 text-yellow-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                        Power (watts)
                                    </h5>
                                    <div class="h-48">
                                        <canvas id="power-chart"></canvas>
                                    </div>
                                </div>
                                
                                <div id="cadence-chart-container" class="bg-white/80 dark:bg-gray-900/40 border border-gray-200/60 dark:border-gray-700/60 rounded-lg p-3 shadow-sm">
                                    <h5 class="text-sm font-medium bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2 flex items-center">
                                        <svg class="w-4 h-4 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Cadence (rpm)
                                    </h5>
                                    <div class="h-48">
                                        <canvas id="cadence-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="charts-loading" class="hidden text-center py-8">
                            <svg class="animate-spin w-8 h-8 mx-auto text-primary-600" fill="none" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                                <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path>
                        </svg>
                            <span class="block mt-2 text-sm text-gray-600 dark:text-gray-400">Loading charts...</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="text-sm md:text-md font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2">Tags</h4>
                        <div class="bg-white/70 dark:bg-gray-800/40 p-2 rounded-md border border-gray-200/60 dark:border-gray-700/60">
                            <div id="tags-current" class="flex flex-wrap gap-2 mb-2"></div>
                            <div class="flex flex-wrap items-center gap-2">
                                <div id="preset-tags" class="flex flex-wrap gap-2"></div>
                                <div class="flex items-center gap-2">
                                    <input id="custom-tag-input" type="text" placeholder="Add custom tag" class="px-2 py-1 text-xs rounded-md bg-white/80 dark:bg-gray-900/50 border border-gray-200/60 dark:border-gray-700/60 text-gray-700 dark:text-gray-200 focus:outline-none">
                                    <button id="add-custom-tag" class="px-2 py-1 text-xs rounded-md border border-primary-500/30 dark:border-primary-600/40 text-primary-700 dark:text-primary-300 bg-white/80 dark:bg-gray-900/50 hover:bg-primary-50/70 dark:hover:bg-gray-800/60">Add</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="text-sm md:text-md font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2">File Information</h4>
                        <div class="bg-white/70 dark:bg-gray-800/40 p-2 rounded-md border border-gray-200/60 dark:border-gray-700/60">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">Filename:</span>
                                    <span id="detail-filename" class="font-medium text-gray-900 dark:text-white">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">Upload Date:</span>
                                    <span id="detail-upload-date" class="font-medium text-gray-900 dark:text-white">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">Status:</span>
                                    <span id="detail-status" class="font-medium text-gray-900 dark:text-white">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">File Hash:</span>
                                    <span id="detail-hash" class="font-mono text-xs text-gray-900 dark:text-white">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    

                    
            <div class="px-4 py-3 bg-white/70 dark:bg-gray-800/40 border-t border-gray-200/60 dark:border-gray-700/60 flex justify-between items-center rounded-b-2xl">
                        <button 
                            id="delete-workout-btn" 
                class="inline-flex items-center px-3 py-1.5 border border-red-300/70 dark:border-red-600/70 text-sm font-medium rounded-md text-red-700 dark:text-red-400 bg-white/80 dark:bg-gray-900/50 hover:bg-red-50/80 dark:hover:bg-red-900/30 transition-colors duration-200"
                        >
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Delete Workout
                        </button>
                        
                        <button 
                            id="close-modal-footer" 
                class="inline-flex items-center px-3 py-1.5 border border-gray-300/70 dark:border-gray-600/70 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white/80 dark:bg-gray-900/50 hover:bg-gray-50/80 dark:hover:bg-gray-800/60 transition-colors duration-200"
                        >
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-white/80 dark:bg-gray-900/60 backdrop-blur-sm border-t border-white/60 dark:border-gray-700/60">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-sm text-gray-500 dark:text-gray-400">
                <a href="https://github.com/janmarkus-dev/OpenConnectCompanion" target="_blank" rel="noopener noreferrer" class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 underline">
                    OpenConnect Companion
                </a> - Independent open-source project, not affiliated with Garmin Ltd.
            </p>
        </div>
    </footer>

    <script>
        let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        let serverTimezoneInfo = null;

        async function initializeTimezone() {
            try {
                const response = await fetch('/api/timezone');
                if (response.ok) {
                    serverTimezoneInfo = await response.json();
                    console.log('Server timezone:', serverTimezoneInfo.timezone_name);
                    console.log('User timezone:', userTimezone);
                }
            } catch (error) {
                console.warn('Could not fetch server timezone info:', error);
            }
        }

        function formatTimeForDisplay(timestamp) {
            if (!timestamp) return 'Unknown';
            try {
                const date = new Date(timestamp);
                return date.toLocaleString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short'
                });
            } catch (error) {
                console.warn('Error formatting timestamp:', error);
                return timestamp;
            }
        }

        function formatDateForDisplay(timestamp) {
            if (!timestamp) return 'Unknown';
            try {
                const date = new Date(timestamp);
                return date.toLocaleDateString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                console.warn('Error formatting date:', error);
                return timestamp;
            }
        }

        function formatActivityType(activityType) {
            if (!activityType || activityType === 'Unknown') return 'Unknown';
            
            return activityType
                .split(/[_\s]+/)
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

        function getWorkoutTypeIcon(activityType) {
            if (!activityType) activityType = 'unknown';
            const type = activityType.toLowerCase();
            
            // Common workout type mappings with Font Awesome icons
            if (type.includes('cycling') || type.includes('bike') || type.includes('biking')) {
                return {
                    icon: `<svg width="21" height="21" viewBox="0 0 24 24"><path fill="currentColor" d="M15.792 3.616a1.25 1.25 0 1 0-1.768 1.768a1.25 1.25 0 0 0 1.768-1.768m1.276 6.602a.75.75 0 1 0 .088-1.497l-2.082-.122a.75.75 0 0 1-.636-.432l-.784-1.68a1.593 1.593 0 0 0-2.568-.452L8.429 8.693a1.61 1.61 0 0 0 .386 2.562l2.056 1.089a.75.75 0 0 1 .399.668l-.018 2.659a.75.75 0 0 0 1.5.01l.018-2.66a2.25 2.25 0 0 0-1.197-2.003l-1.272-.673l2.385-2.387l.394.843a2.25 2.25 0 0 0 1.907 1.295z"/><path fill="currentColor" fill-rule="evenodd" d="M2 15.75a3.75 3.75 0 1 1 7.5 0a3.75 3.75 0 0 1-7.5 0m3.75-2.25a2.25 2.25 0 1 0 0 4.5a2.25 2.25 0 0 0 0-4.5m12.5-1.5a3.75 3.75 0 1 0 0 7.5a3.75 3.75 0 0 0 0-7.5M16 15.75a2.25 2.25 0 1 1 4.5 0a2.25 2.25 0 0 1-4.5 0" clip-rule="evenodd"/></svg>`,
            color: 'text-blue-600 dark:text-blue-300',
            bgColor: 'bg-blue-500/10 border border-blue-200/60 dark:border-blue-800/60'
                };
            }
            
            if (type.includes('running') || type.includes('run') || type.includes('jog')) {
                return {
                    icon: `<svg width="21" height="21" viewBox="0 0 344 464"><path fill="currentColor" d="M226.5 85Q209 85 196 72.5t-13-30t13-30T226.5 0t30 12.5t12.5 30t-12.5 30t-30 12.5zM149 381L0 352l9-43l104 21l34-173l-38 15v73H66V145l111-47q3 0 8.5-1t8.5-1q22 0 36 21l22 34q13 23 37.5 37t53.5 14v43q-71 0-117-53l-13 64l45 42v160h-43V330l-44-42z"/></svg>`,
                    color: 'text-emerald-600 dark:text-emerald-300',
                    bgColor: 'bg-emerald-500/10 border border-emerald-200/60 dark:border-emerald-800/60'
                };
            }
            
            if (type.includes('swimming') || type.includes('swim')) {
                return {
                    icon: `<svg width="21" height="21" viewBox="0 0 15 15"><path fill="currentColor" d="M10.111 2c-.112 0-.435.147-.435.147l-3.322 1.68c-.443.175-.618.881-.352 1.234l.97 1.408l-3.97 2.029L5 9.998l2.502-1.5l2.5 1.5l1.002-1.002l-3-4l2.557-1.53c.528-.266.443-.704.443-.97C11 2.286 10.644 2 10.111 2zm2.141 3a1.75 1.75 0 1 0-.003 3.501A1.75 1.75 0 0 0 12.252 5zM2.5 10L0 11.5V13l2.5-1.5L5 13l2.502-1.5l2.5 1.5L12 11.5l3 1.5v-1.5L12 10l-1.998 1.5l-2.5-1.5L5 11.5L2.5 10z"/></svg>`,
                    color: 'text-cyan-600 dark:text-cyan-300',
                    bgColor: 'bg-cyan-500/10 border border-cyan-200/60 dark:border-cyan-800/60'
                };
            }
            
            if (type.includes('walking') || type.includes('walk') || type.includes('hiking') || type.includes('hike')) {
                return {
                    icon: `<svg width="21" height="21" viewBox="0 0 100 100"><path id="gisHiker0" fill="currentColor" fill-opacity="1" fill-rule="evenodd" stroke="none" stroke-dasharray="1.029 .514" stroke-dashoffset="5.041" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="4" stroke-opacity="1" stroke-width=".514" d="M46.43 7.5c4.055 0 7.337 3.379 7.337 7.434c0 4.054-3.282 7.433-7.337 7.433s-7.434-3.379-7.434-7.433c0-4.055 3.38-7.434 7.434-7.434zm.483 15.543c2.79-.087 4.947 1.649 6.082 3.476l7.723 12.84l13.516 5.696c3.861 1.64 2.027 6.757-2.317 5.599a5.015 5.015 0 0 0-.483-.29l-9.075 20.08s2.896 6.662 6.565 14.193c3.572 7.626-5.117 10.909-8.303 3.861l-3.185-7.144l-4.634 10.137l-1.931-.869l5.406-11.778l-9.075-19.79c-.386.096-.772 0-1.255 0c0 0-10.523 23.941-13.42 30.217c-2.799 6.275-11.101 2.51-8.302-3.67c2.8-6.178 16.123-36.202 16.123-36.202l-9.903.162c-1.5.013-1.859-.226-1.954-1.35c-.153-2.97-.415-9.958.272-13.197c.886-4.175 1.415-8.77 4.344-10.137c2.93-1.367 8.013 2.414 8.013 2.414c.772-2.51 3.186-4.248 5.793-4.248zm5.985 15.06V49.69l8.303 18.15l8.302-18.247l-12.067-5.02c-.58-.29-1.062-.676-1.449-1.255z" color="currentColor" color-interpolation="sRGB" color-rendering="auto" display="inline" opacity="1" vector-effect="none" visibility="visible"/></svg>`,
                    color: 'text-teal-600 dark:text-teal-300',
                    bgColor: 'bg-teal-500/10 border border-teal-200/60 dark:border-teal-800/60'
                };
            }
            
            if (type.includes('strength') || type.includes('weight') || type.includes('training') || type.includes('gym')) {
                return {
                    icon: `<svg width="21" height="21" viewBox="0 0 24 24"><path fill="currentColor" d="M12 5c-1.11 0-2 .89-2 2s.89 2 2 2s2-.89 2-2s-.89-2-2-2m10-4v5h-2V4H4v2H2V1h2v2h16V1h2m-7 10.26V23h-2v-5h-2v5H9V11.26C6.93 10.17 5.5 8 5.5 5.5V5h2v.5C7.5 8 9.5 10 12 10s4.5-2 4.5-4.5V5h2v.5c0 2.5-1.43 4.67-3.5 5.76Z"/></svg>`,
                    color: 'text-purple-600 dark:text-purple-300',
                    bgColor: 'bg-purple-500/10 border border-purple-200/60 dark:border-purple-800/60'
                };
            }
            
            return {
                icon: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 512 512">
                    <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/>
                </svg>`,
                color: 'text-gray-600 dark:text-gray-300',
                bgColor: 'bg-gray-500/10 border border-gray-300/60 dark:border-gray-700/60'
            };
        }

        initializeTimezone();

        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const html = document.documentElement;

        const currentTheme = localStorage.getItem('theme') || 'light';
        
        if (currentTheme === 'dark') {
            html.classList.add('dark');
        }

        themeToggle.addEventListener('click', () => {
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }

            const modal = document.getElementById('workout-modal');
            const routeSection = document.getElementById('route-map-section');
            if (!modal.classList.contains('hidden') && routeSection && !routeSection.classList.contains('hidden')) {
                const iframe = document.getElementById('route-map-iframe');
                const src = new URL(iframe.src, window.location.origin);
                const newTheme = html.classList.contains('dark') ? 'dark' : 'light';
                src.searchParams.set('theme', newTheme);
                iframe.src = src.toString();
            }
        });

        if (localStorage.getItem('theme') === 'dark') {
            html.classList.add('dark');
        }

        const fileInput = document.getElementById('fit-file-upload');
        const folderInput = document.getElementById('fit-folder-upload');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadStatus = document.getElementById('upload-status');
        const fileList = document.getElementById('file-list');
        const selectedFiles = document.getElementById('selected-files');
        
        let filesToUpload = [];

        fileInput.addEventListener('change', handleFileSelection);
        folderInput.addEventListener('change', handleFileSelection);
        
        function handleFileSelection(event) {
            const files = Array.from(event.target.files);
            const fitFiles = files.filter(file => file.name.toLowerCase().endsWith('.fit'));
            
            // Add new files to existing list (avoid duplicates by name)
            const existingNames = filesToUpload.map(f => f.name);
            const newFiles = fitFiles.filter(file => !existingNames.includes(file.name));
            filesToUpload = [...filesToUpload, ...newFiles];
            
            if (filesToUpload.length > 0) {
                displaySelectedFiles();
                fileList.classList.remove('hidden');
            } else {
                fileList.classList.add('hidden');
            }
            
            // Show info about filtered files
            if (files.length > fitFiles.length) {
                const nonFitCount = files.length - fitFiles.length;
                showStatus(`Found ${fitFiles.length} .fit file(s). ${nonFitCount} non-.fit file(s) were filtered out.`, 'info');
            }
        }

        function displaySelectedFiles() {
            selectedFiles.innerHTML = '';
            
            // Update heading with file count
            const headingElement = document.querySelector('#file-list h4');
            headingElement.textContent = `Selected FIT Files (${filesToUpload.length})`;
            
            filesToUpload.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between py-1 px-2 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-600';
                
                // Show file path if it's from a folder upload
                const displayPath = file.webkitRelativePath || file.name;
                const fileName = file.name;
                const folderPath = file.webkitRelativePath ? file.webkitRelativePath.replace(fileName, '') : '';
                
                li.innerHTML = `
                    <div class="flex-1 mr-2 min-w-0">
                        <div class="text-xs text-gray-700 dark:text-gray-300 truncate font-medium">${fileName}</div>
                        ${folderPath ? `<div class="text-xs text-gray-500 dark:text-gray-400 truncate">${folderPath}</div>` : ''}
                    </div>
                    <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 flex-shrink-0">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                selectedFiles.appendChild(li);
            });
        }

        function removeFile(index) {
            filesToUpload.splice(index, 1);
            if (filesToUpload.length > 0) {
                displaySelectedFiles();
            } else {
                fileList.classList.add('hidden');
            }
        }

        async function handleUpload() {
            if (filesToUpload.length === 0) {
                showStatus('Please select at least one FIT file.', 'error');
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<svg class="animate-spin w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path></svg>Uploading...';

            let successCount = 0;
            let errorCount = 0;
            let errorMessages = [];

            for (const file of filesToUpload) {
                try {
                    const formData = new FormData();
                    formData.append('fit_file', file);

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        successCount++;
                        console.log(`Successfully uploaded: ${file.name}`);
                    } else {
                        errorCount++;
                        const errorMsg = `${file.name}: ${result.error || 'Unknown error'}`;
                        errorMessages.push(errorMsg);
                        console.error(`Error uploading ${file.name}:`, result.error);
                    }
                } catch (error) {
                    errorCount++;
                    const errorMsg = `${file.name}: ${error.message}`;
                    errorMessages.push(errorMsg);
                    console.error(`Error uploading ${file.name}:`, error);
                }
            }

            filesToUpload = [];
            fileInput.value = '';
            folderInput.value = '';
            fileList.classList.add('hidden');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>Upload';

            // Show status
            if (successCount > 0 && errorCount === 0) {
                showStatus(`Successfully uploaded ${successCount} file(s).`, 'success');
                loadWorkouts(1); // Refresh workout list
                loadStats(); // Refresh stats
            } else if (successCount > 0 && errorCount > 0) {
                showStatus(`Uploaded ${successCount} file(s), ${errorCount} failed.`, 'warning');
                loadWorkouts(1);
                loadStats();
            } else {
                showStatus(`Failed to upload ${errorCount} file(s). ${errorMessages.join('; ')}`, 'error');
            }
        }

        uploadBtn.addEventListener('click', handleUpload);

        async function handleGarminSync() {
            const garminBtn = document.getElementById('garmin-upload-btn');

            garminBtn.disabled = true;
            const originalHTML = garminBtn.innerHTML;
            garminBtn.innerHTML = `
                <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                    <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path>
                </svg>
                Syncing...
            `;

            try {
                const response = await fetch('/api/devices/scan-fit-files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.devices_scanned === 0) {
                    showStatus('No Garmin devices detected. Make sure your device is connected and mounted.', 'warning');
                } else if (result.files_uploaded > 0) {
                    const message = `Successfully synced ${result.files_uploaded} workout(s) from your Garmin device${result.files_skipped > 0 ? ` (${result.files_skipped} already existed)` : ''}.`;
                    showStatus(message, 'success');
                    loadWorkouts(1); // Refresh workout list
                    loadStats(); // Refresh stats
                } else if (result.files_found === 0) {
                    showStatus('No .FIT files found in the Activities folder on your Garmin device.', 'warning');
                } else {
                    showStatus(`Found ${result.files_found} file(s) but couldn't upload any. Check the console for details.`, 'error');
                }

                if (result.errors && result.errors.length > 0) {
                    console.error('Garmin sync errors:', result.errors);
                }
                
            } catch (error) {
                console.error('Error during Garmin sync:', error);
                showStatus(`Failed to sync with Garmin device: ${error.message}`, 'error');
            } finally {
                garminBtn.disabled = false;
                garminBtn.innerHTML = originalHTML;
            }
        }

        document.getElementById('garmin-upload-btn').addEventListener('click', handleGarminSync);

        function showStatus(message, type) {
            const toastType = (type === 'success' || type === 'error' || type === 'warning') ? type : 'info';
            showNotification(message, toastType);
        }

        async function loadWorkouts(page = 1) {
            try {
                currentPage = page;
                const offset = (page - 1) * workoutsPerPage;
                const qs = new URLSearchParams({ 
                    limit: workoutsPerPage.toString(),
                    offset: offset.toString()
                });
                
                if (typeof activeTagFilter === 'string' && activeTagFilter.trim()) {
                    qs.set('tag', activeTagFilter.trim());
                }
                
                const response = await fetch('/api/workouts?' + qs.toString());
                const data = await response.json();
                
                totalWorkouts = data.total_count || 0;
                const workoutsList = document.getElementById('workouts-list');
                
                if (data.workouts && data.workouts.length > 0) {
                    workoutsList.innerHTML = '';
                    data.workouts.forEach(workout => {
                        const workoutElement = createWorkoutElement(workout);
                        workoutsList.appendChild(workoutElement);
                        try {
                            const tags = workout.tags ? (Array.isArray(workout.tags) ? workout.tags : JSON.parse(workout.tags)) : [];
                            if (Array.isArray(tags)) {
                                tags.forEach(t => { if (typeof t === 'string' && t.trim()) knownTagSet.add(t.trim()); });
                            }
                        } catch {}
                    });
                    renderTagFilterBar();
                    renderPaginationControls();
                } else {
                    workoutsList.innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400">No workouts found. Upload some FIT files to get started!</div>';
                    hidePaginationControls();
                }
            } catch (error) {
                console.error('Error loading workouts:', error);
                document.getElementById('workouts-list').innerHTML = '<div class="text-center py-8 text-red-500">Error loading workouts.</div>';
                hidePaginationControls();
            }
        }

        function renderPaginationControls() {
            const totalPages = Math.ceil(totalWorkouts / workoutsPerPage);
            
            if (totalPages <= 1) {
                hidePaginationControls();
                return;
            }
            
            const paginationControls = document.getElementById('pagination-controls');
            const paginationInfo = document.getElementById('pagination-info');
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            const pageNumbers = document.getElementById('page-numbers');
            
            // Update pagination info
            const startItem = (currentPage - 1) * workoutsPerPage + 1;
            const endItem = Math.min(currentPage * workoutsPerPage, totalWorkouts);
            paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalWorkouts} workouts`;
            
            // Update prev/next buttons
            prevButton.disabled = currentPage <= 1;
            nextButton.disabled = currentPage >= totalPages;
            
            // Generate page numbers
            pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // Add first page and ellipsis if needed
            if (startPage > 1) {
                addPageButton(1);
                if (startPage > 2) {
                    addEllipsis();
                }
            }
            
            // Add visible page numbers
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(i);
            }
            
            // Add ellipsis and last page if needed
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    addEllipsis();
                }
                addPageButton(totalPages);
            }
            
            paginationControls.classList.remove('hidden');
        }
        
        function addPageButton(pageNum) {
            const pageNumbers = document.getElementById('page-numbers');
            const button = document.createElement('button');
            button.className = `px-3 py-1.5 text-sm font-medium rounded-md transition-colors duration-200 ${
                pageNum === currentPage 
                    ? 'bg-primary-500 text-white' 
                    : 'text-gray-600 dark:text-gray-400 bg-white/80 dark:bg-gray-800/60 border border-gray-200/60 dark:border-gray-700/60 hover:bg-gray-50/80 dark:hover:bg-gray-700/60'
            }`;
            button.textContent = pageNum.toString();
            button.onclick = () => loadWorkouts(pageNum);
            pageNumbers.appendChild(button);
        }
        
        function addEllipsis() {
            const pageNumbers = document.getElementById('page-numbers');
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-2 py-1.5 text-sm text-gray-400 dark:text-gray-500';
            ellipsis.textContent = '...';
            pageNumbers.appendChild(ellipsis);
        }
        
        function hidePaginationControls() {
            const paginationControls = document.getElementById('pagination-controls');
            paginationControls.classList.add('hidden');
        }

        async function loadMonthlySummary() {
            try {
                const res = await fetch('/api/monthly-summary');
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                const start = new Date(data.month_start);
                const end = new Date(data.month_end);
                const fmt = (d, opts) => d.toLocaleDateString(undefined, opts);
                const sameMonth = start.getMonth() === new Date(end.getTime() - 24*60*60*1000).getMonth();
                const rangeText = sameMonth
                    ? `${fmt(start, { month: 'long' })} ${start.getFullYear()}`
                    : `${fmt(start, { month: 'short', year: 'numeric' })} - ${fmt(new Date(end.getTime() - 24*60*60*1000), { month: 'short', year: 'numeric' })}`;
                document.getElementById('month-range').textContent = rangeText;

                document.getElementById('monthly-workouts').textContent = data.workouts_count ?? 0;

                const km = (data.total_distance_m || 0) / 1000;
                document.getElementById('monthly-distance').textContent = `${km.toFixed(2)} km`;

                document.getElementById('monthly-duration').textContent = formatDuration(data.total_duration_s || 0);

                document.getElementById('monthly-calories').textContent = `${data.total_calories || 0} kcal`;
            } catch (err) {
                console.error('Error loading monthly summary:', err);
                document.getElementById('month-range').textContent = 'This Month';
                document.getElementById('monthly-workouts').textContent = '';
                document.getElementById('monthly-distance').textContent = '';
                document.getElementById('monthly-duration').textContent = '';
                document.getElementById('monthly-calories').textContent = '';
            }
        }

        // GitHub-style contribution calendar functionality
        async function loadContributionCalendar() {
            try {
                const res = await fetch('/api/contribution-calendar');
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                renderMonthlyCalendar(data.data, data.month_name);
                updateCalendarStats(data.data);
            } catch (err) {
                console.error('Error loading contribution calendar:', err);
                // Show fallback message
                document.getElementById('contribution-calendar').innerHTML = '<div class="col-span-7 text-center text-gray-500 dark:text-gray-400 py-4">Failed to load activity calendar</div>';
            }
        }

        function renderMonthlyCalendar(calendarData, monthName) {
            const calendar = document.getElementById('contribution-calendar');
            calendar.innerHTML = '';

            // Create a map for quick lookup
            const dataMap = new Map();
            calendarData.forEach(day => {
                dataMap.set(day.date, day);
            });

            // Get first day of month and determine starting day of week
            const firstDay = new Date(calendarData[0].date);
            const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
            
            // Calculate how many weeks we need
            const totalDays = calendarData.length;
            const totalCells = startDayOfWeek + totalDays;
            const weeksNeeded = Math.ceil(totalCells / 7);

            // Create week rows
            for (let week = 0; week < weeksNeeded; week++) {
                const weekRow = document.createElement('div');
                weekRow.className = 'grid grid-cols-7 gap-1 mb-1';
                
                // Create 7 days for each week
                for (let day = 0; day < 7; day++) {
                    const cellIndex = (week * 7) + day;
                    const dayElement = document.createElement('div');
                    dayElement.className = 'h-8 w-full rounded-md cursor-pointer transition-all duration-200 border border-gray-200 dark:border-gray-600 flex items-center justify-center text-xs font-medium';
                    
                    // Check if this is before the first day of the month or after the last day
                    if (cellIndex < startDayOfWeek || cellIndex >= startDayOfWeek + totalDays) {
                        // Empty cell - make it invisible
                        dayElement.className = 'h-8 w-full'; // Just spacing, no background or border
                        dayElement.style.visibility = 'hidden';
                    } else {
                        // This is a valid day in the month
                        const dayIndex = cellIndex - startDayOfWeek;
                        const dayData = calendarData[dayIndex];
                        const date = new Date(dayData.date);
                        const dayNumber = date.getDate();
                        
                        // Add the day number
                        dayElement.textContent = dayNumber;
                        
                        // Simple binary coloring: has workout or not
                        if (dayData.count === 0) {
                            dayElement.className += ' bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700';
                        } else {
                            dayElement.className += ' bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 border-green-300 dark:border-green-700 hover:bg-green-200 dark:hover:bg-green-800';
                        }
                        
                        // Add tooltip
                        dayElement.title = createTooltipText(dayData, date);
                        
                        // Add hover animation
                        dayElement.addEventListener('mouseenter', function() {
                            this.style.transform = 'scale(1.05)';
                            this.style.zIndex = '10';
                        });
                        dayElement.addEventListener('mouseleave', function() {
                            this.style.transform = 'scale(1)';
                            this.style.zIndex = 'auto';
                        });
                        
                        // Add click handler to show workouts for that day
                        dayElement.addEventListener('click', () => showWorkoutsForDay(dayData, date));
                    }
                    
                    weekRow.appendChild(dayElement);
                }
                
                calendar.appendChild(weekRow);
            }
        }

        function createTooltipText(dayData, date) {
            const dateStr = date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric' 
            });
            
            if (dayData.count === 0) {
                return `No workouts on ${dateStr}`;
            } else if (dayData.count === 1) {
                return `1 workout on ${dateStr}`;
            } else {
                return `${dayData.count} workouts on ${dateStr}`;
            }
        }

        async function showWorkoutsForDay(dayData, date) {
            if (dayData.count === 0) {
                const dateStr = date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'long', 
                    day: 'numeric' 
                });
                alert(`No workouts recorded for ${dateStr}`);
                return;
            }
            
            // If there's only one workout, show it directly
            if (dayData.workout_ids.length === 1) {
                showWorkoutDetails(dayData.workout_ids[0]);
                return;
            }
            
            // Multiple workouts - show selection dialog
            const dateStr = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'long', 
                day: 'numeric' 
            });
            
            try {
                // Fetch workout details for this day
                const workoutPromises = dayData.workout_ids.map(id => 
                    fetch(`/api/workouts/${id}`).then(res => res.json())
                );
                const workouts = await Promise.all(workoutPromises);
                
                // Create a selection dialog
                let message = `Select a workout to view from ${dateStr}:\n\n`;
                workouts.forEach((workout, index) => {
                    const startTime = workout.start_time ? formatDateForDisplay(workout.start_time) : 'Unknown time';
                    const duration = workout.duration_seconds ? formatDuration(workout.duration_seconds) : 'Unknown duration';
                    const distance = workout.distance_meters ? (workout.distance_meters / 1000).toFixed(2) + ' km' : 'Unknown distance';
                    const type = workout.workout_type || 'Unknown type';
                    
                    message += `${index + 1}. ${type} - ${duration} - ${distance}\n`;
                });
                
                const selection = prompt(message + '\nEnter the number of the workout you want to view (1-' + workouts.length + '):');
                
                if (selection && !isNaN(selection)) {
                    const index = parseInt(selection) - 1;
                    if (index >= 0 && index < workouts.length) {
                        showWorkoutDetails(workouts[index].id);
                    }
                }
                
            } catch (err) {
                console.error('Error fetching workouts for day:', err);
                alert('Failed to load workout details for this day');
            }
        }

        function updateCalendarStats(calendarData) {
            // Calculate active days (days with workouts)
            const activeDays = calendarData.filter(day => day.count > 0).length;
            document.getElementById('active-days').textContent = `${activeDays} day${activeDays !== 1 ? 's' : ''}`;
            
            // Calculate current streak (from today backwards)
            let currentStreak = 0;
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Find today's index in the calendar data
            let todayIndex = -1;
            for (let i = 0; i < calendarData.length; i++) {
                if (calendarData[i].date === todayStr) {
                    todayIndex = i;
                    break;
                }
            }
            
            // If today is found, count backwards from today
            if (todayIndex >= 0) {
                for (let i = todayIndex; i >= 0; i--) {
                    if (calendarData[i].count > 0) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
            }
            
            document.getElementById('current-streak').textContent = `${currentStreak} day${currentStreak !== 1 ? 's' : ''}`;
        }

        const PRESET_TAGS = ['Commute','Zone 2','Intervals','Ride'];
        let knownTagSet = new Set(PRESET_TAGS);
        
        function createTagChip(label, options = {}) {
            const { removable = false, onRemove } = options;
            const chip = document.createElement('span');
            chip.className = 'inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] bg-white/70 dark:bg-gray-900/40 border border-gray-200/60 dark:border-gray-700/60 text-gray-700 dark:text-gray-200';
            chip.textContent = label;
            if (removable) {
                const btn = document.createElement('button');
                btn.className = 'ml-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300';
                btn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
                btn.addEventListener('click', (e) => { e.stopPropagation(); onRemove && onRemove(); });
                chip.appendChild(btn);
            }
            return chip;
        }

        function createWorkoutElement(workout) {
            const div = document.createElement('div');
            div.className = 'group rounded-2xl p-[1px] bg-gradient-to-r from-gray-200/60 via-gray-100/40 to-gray-200/60 dark:from-gray-700/60 dark:via-gray-800/60 dark:to-gray-700/60 hover:from-blue-200/50 hover:via-cyan-200/40 hover:to-emerald-200/50 dark:hover:from-gray-700/80 dark:hover:via-gray-800/80 dark:hover:to-gray-700/80 transition-colors duration-200 cursor-pointer';
            div.onclick = () => showWorkoutDetails(workout.id);
            
            const startTime = workout.start_time ? formatDateForDisplay(workout.start_time) : 'Unknown';
            const duration = workout.duration_seconds ? formatDuration(workout.duration_seconds) : 'Unknown';
            const distance = workout.distance_meters ? (workout.distance_meters / 1000).toFixed(2) + ' km' : 'Unknown';
            const workoutIcon = getWorkoutTypeIcon(workout.workout_type);
            const displayName = (workout.name && workout.name.trim().length > 0) ? workout.name.trim() : '';
            
            div.innerHTML = `
                <div class="rounded-[15px] p-3 bg-white/80 dark:bg-gray-900/40 backdrop-blur-sm">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1 gap-3">
                        <div class="flex-shrink-0 w-10 h-10 ${workoutIcon.bgColor} rounded-lg flex items-center justify-center shadow-sm">
                            <div class="${workoutIcon.color}">
                                ${workoutIcon.icon}
                            </div>
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-0.5">
                                <h4 class="text-sm sm:text-base font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent truncate">${displayName || startTime}</h4>
                                ${displayName ? `<span class="text-[11px] text-gray-400 dark:text-gray-500 truncate max-w-[30ch] hidden sm:inline">${startTime}</span>` : ''}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold text-blue-700 dark:text-blue-300 bg-white/70 dark:bg-gray-900/40 border border-blue-200/60 dark:border-blue-800/60 backdrop-blur-sm">
                                    ${duration}
                                </span>
                            </div>
                            
                            <div class="flex items-center gap-2 sm:gap-3 text-xs sm:text-sm text-gray-600 dark:text-gray-300">
                                <span class="font-medium">${distance}</span>
                                <span class="mx-1.5 text-gray-300 dark:text-gray-600 select-none"></span>
                                <span class="truncate">${formatActivityType(workout.workout_type)}</span>
                                ${(() => {
                                    let tagsHtml = '';
                                    try {
                                        const tags = workout.tags ? JSON.parse(workout.tags) : [];
                                        if (Array.isArray(tags) && tags.length) {
                                            tagsHtml = '<span class="mx-1.5 text-gray-300 dark:text-gray-600 select-none"></span>' + tags.slice(0,3).map(t => `<span class=\"inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-white/70 dark:bg-gray-900/40 border border-gray-200/60 dark:border-gray-700/60 text-gray-600 dark:text-gray-300\">${t}</span>`).join(' ');
                                        }
                                    } catch (e) {}
                                    return tagsHtml;
                                })()}
                            </div>
                            
                            <div class="text-[11px] text-gray-400 dark:text-gray-500 truncate mt-0.5 opacity-0 group-hover:opacity-70 transition-opacity duration-200 hidden sm:block">
                                ${workout.filename}
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 flex-shrink-0">
                        ${workout.processed ? 
                            '<span class="inline-flex items-center gap-1 text-[10px] font-semibold tracking-wider text-emerald-600 dark:text-emerald-400"><span class="w-2 h-2 rounded-full bg-emerald-500/70"></span><span class="hidden md:inline">Processed</span></span>' : 
                            '<span class="inline-flex items-center gap-1 text-[10px] font-semibold tracking-wider text-amber-600 dark:text-amber-400"><span class="w-2 h-2 rounded-full bg-amber-500/70"></span><span class="hidden md:inline">Processing</span></span>'
                        }
                        <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                  </div>
                </div>
            `;
            
            return div;
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m ${secs}s`;
            }
        }

        async function showWorkoutDetails(workoutId) {
            const modal = document.getElementById('workout-modal');
            const modalLoading = document.getElementById('modal-loading');
            const modalData = document.getElementById('modal-workout-data');
            
            modal.classList.remove('hidden');
            modalLoading.classList.remove('hidden');
            modalData.classList.add('hidden');
            
            try {
                const response = await fetch(`/api/workouts/${workoutId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch workout details');
                }
                
                const workout = await response.json();
                populateWorkoutModal(workout);
                
                // Wait a bit more before hiding the loading spinner to let charts start loading
                setTimeout(() => {
                    modalLoading.classList.add('hidden');
                    modalData.classList.remove('hidden');
                }, 300);
                
            } catch (error) {
                console.error('Error loading workout details:', error);
                modalLoading.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p>Error loading workout details</p>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        function populateWorkoutModal(workout) {
            const titleEl = document.getElementById('modal-title');
            const currentDisplayName = (workout.name && workout.name.trim().length > 0) ? workout.name.trim() : workout.filename;
            titleEl.textContent = '';
            const wrap = document.createElement('div');
            wrap.className = 'flex items-center gap-2';
            const span = document.createElement('span');
            span.className = 'truncate';
            span.textContent = currentDisplayName;
            const btn = document.createElement('button');
            btn.className = 'ml-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300';
            btn.title = 'Rename workout';
            btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M4 20h4l10.243-10.243a2.5 2.5 0 10-3.536-3.536L4 16v4z"/></svg>';
            wrap.appendChild(span);
            wrap.appendChild(btn);
            titleEl.appendChild(wrap);
            // Wire rename prompt
            btn.addEventListener('click', async () => {
                const proposed = prompt('Enter a name for this workout:', (workout.name && workout.name.trim()) || '');
                if (proposed === null) return; // canceled
                const name = proposed.trim();
                if (!name) {
                    showNotification('Name cannot be empty', 'warning');
                    return;
                }
                try {
                    const resp = await fetch(`/api/workouts/${workout.id}/rename`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
                    const result = await resp.json();
                    if (!resp.ok) throw new Error(result.error || 'Rename failed');
                    span.textContent = name;
                    await loadWorkouts(currentPage);
                    showNotification('Workout renamed', 'success');
                } catch (e) {
                    console.error('Rename failed:', e);
                    showNotification(`Failed to rename: ${e.message}`, 'error');
                }
            });
            
            document.getElementById('detail-workout-type').textContent = formatActivityType(workout.workout_type);
            document.getElementById('detail-start-time').textContent = workout.start_time 
                ? formatTimeForDisplay(workout.start_time)
                : 'Unknown';
            document.getElementById('detail-duration').textContent = workout.duration_seconds 
                ? formatDuration(workout.duration_seconds) 
                : 'Unknown';
            document.getElementById('detail-distance').textContent = workout.distance_meters 
                ? `${(workout.distance_meters / 1000).toFixed(2)} km` 
                : 'Unknown';
            
            document.getElementById('detail-hr-avg').textContent = workout.avg_heart_rate 
                ? `${workout.avg_heart_rate} bpm` 
                : 'N/A';
            document.getElementById('detail-hr-max').textContent = workout.max_heart_rate 
                ? `${workout.max_heart_rate} bpm` 
                : 'N/A';
            
            document.getElementById('detail-power-avg').textContent = workout.avg_power_watts 
                ? `${workout.avg_power_watts} W` 
                : 'N/A';
            document.getElementById('detail-power-max').textContent = workout.max_power_watts 
                ? `${workout.max_power_watts} W` 
                : 'N/A';
            
            document.getElementById('detail-cadence-avg').textContent = workout.avg_cadence 
                ? `${workout.avg_cadence} rpm` 
                : 'N/A';
            document.getElementById('detail-cadence-max').textContent = workout.max_cadence 
                ? `${workout.max_cadence} rpm` 
                : 'N/A';
            
            document.getElementById('detail-speed-avg').textContent = workout.avg_speed_mps 
                ? `${(workout.avg_speed_mps * 3.6).toFixed(1)} km/h` 
                : 'N/A';
            document.getElementById('detail-speed-max').textContent = workout.max_speed_mps 
                ? `${(workout.max_speed_mps * 3.6).toFixed(1)} km/h` 
                : 'N/A';
            
            document.getElementById('detail-calories').textContent = workout.total_calories || 'N/A';
            
            document.getElementById('detail-elevation-gain').textContent = workout.elevation_gain_meters 
                ? `${Math.round(workout.elevation_gain_meters)} m` 
                : 'N/A';
            document.getElementById('detail-elevation-loss').textContent = workout.elevation_loss_meters 
                ? `${Math.round(workout.elevation_loss_meters)} m` 
                : 'N/A';
            
            document.getElementById('detail-filename').textContent = workout.filename || 'Unknown';
            document.getElementById('detail-upload-date').textContent = workout.upload_timestamp 
                ? formatDateForDisplay(workout.upload_timestamp)
                : 'Unknown';
            document.getElementById('detail-status').textContent = workout.processed ? 'Processed' : 'Processing';
            document.getElementById('detail-hash').textContent = workout.file_hash 
                ? workout.file_hash.substring(0, 16) + '...' 
                : 'Unknown';
            
            setupCharts(workout.id);
            
            setupDeleteButton(workout.id);

            setupTagsEditor(workout);

            const routeSection = document.getElementById('route-map-section');
            const routeContainer = document.getElementById('route-map-container');
            const iframe = document.getElementById('route-map-iframe');
            const fade = document.getElementById('route-map-fade');
            const toggleBtn = document.getElementById('toggle-map-size');
            const toggleIcon = document.getElementById('toggle-icon');
            const toggleLabel = document.getElementById('toggle-map-label');
            
            routeSection.classList.remove('hidden');
            iframe.style.height = '100%';
            fade.style.opacity = '1';
            toggleBtn.dataset.expanded = 'false';
            toggleIcon.innerHTML = '<path d="M12 5v14m-7-7h14"/>';
            toggleLabel.textContent = 'Expand map';
            
            const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            iframe.src = `/api/workouts/${workout.id}/map/folium?theme=${theme}`;
            
            const newToggle = toggleBtn.cloneNode(true);
            toggleBtn.parentNode.replaceChild(newToggle, toggleBtn);
            
            newToggle.addEventListener('click', () => {
                const expanded = newToggle.dataset.expanded === 'true';
                if (expanded) {
                    newToggle.dataset.expanded = 'false';
                    document.getElementById('toggle-icon').innerHTML = '<path d="M12 5v14m-7-7h14"/>';
                    document.getElementById('toggle-map-label').textContent = 'Expand map';
                    routeContainer.className = 'relative h-48 md:h-64 bg-gray-100 dark:bg-gray-700';
                    fade.style.opacity = '1';
                } else {
                    newToggle.dataset.expanded = 'true';
                    document.getElementById('toggle-icon').innerHTML = '<path d="M18 12H6"/>';
                    document.getElementById('toggle-map-label').textContent = 'Collapse map';
                    routeContainer.className = 'relative h-96 md:h-[32rem] bg-gray-100 dark:bg-gray-700';
                    fade.style.opacity = '0';
                }
            });
        }

        let chartInstances = {};
        
        function setupCharts(workoutId) {
            const chartsContainer = document.getElementById('charts-container');
            const chartsLoading = document.getElementById('charts-loading');

            chartsLoading.classList.remove('hidden');
            chartsContainer.classList.add('hidden');

            Object.values(chartInstances).forEach(chart => {
                if (chart) chart.destroy();
            });
            chartInstances = {};

            fetch(`/api/workouts/${workoutId}/chart`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch chart data');
                    }
                    return response.json();
                })
                .then(chartResponse => {
                    const chartData = chartResponse.chart_data;
                    handleMissingMetrics({
                        hasPower: !!chartResponse.has_power,
                        hasCadence: !!chartResponse.has_cadence
                    });
                    
                    if (chartData && (chartResponse.has_heart_rate || chartResponse.has_speed || chartResponse.has_power || chartResponse.has_cadence)) {
                        createCharts(chartData);
                        chartsLoading.classList.add('hidden');
                        chartsContainer.classList.remove('hidden');
                    } else {
                        throw new Error('No chart data available');
                    }
                })
                .catch(error => {
                    console.error('Error loading chart data:', error);
                    chartsLoading.innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <p>Error loading charts</p>
                            <p class="text-sm">${error.message}</p>
                        </div>
                    `;
                });
        }

        function handleMissingMetrics({ hasPower, hasCadence }) {
            try {
                const powerChartWrap = document.getElementById('power-chart-container');
                const cadenceChartWrap = document.getElementById('cadence-chart-container');
                const powerMetrics = document.getElementById('power-metrics-container');
                const cadenceMetrics = document.getElementById('cadence-metrics-container');

                const muteCard = (el, noteText) => {
                    if (!el) return;
                    el.classList.add('opacity-60');
                    if (!el.querySelector('[data-missing-note]')) {
                        const note = document.createElement('div');
                        note.setAttribute('data-missing-note', '');
                        note.className = 'mt-2 text-[10px] text-gray-500 dark:text-gray-400 italic';
                        note.textContent = noteText;
                        el.appendChild(note);
                    }
                };

                if (!hasPower) {
                    if (powerChartWrap) powerChartWrap.classList.add('hidden');
                    muteCard(powerMetrics, 'No power data in this file');
                    const avg = document.getElementById('detail-power-avg');
                    const max = document.getElementById('detail-power-max');
                    if (avg && (!avg.textContent || avg.textContent === '-' )) avg.textContent = 'N/A';
                    if (max && (!max.textContent || max.textContent === '-' )) max.textContent = 'N/A';
                } else {
                    if (powerChartWrap) powerChartWrap.classList.remove('hidden');
                    if (powerMetrics) powerMetrics.classList.remove('opacity-60');
                    const note = powerMetrics ? powerMetrics.querySelector('[data-missing-note]') : null;
                    if (note) note.remove();
                }

                if (!hasCadence) {
                    if (cadenceChartWrap) cadenceChartWrap.classList.add('hidden');
                    muteCard(cadenceMetrics, 'No cadence data in this file');
                    const avg = document.getElementById('detail-cadence-avg');
                    const max = document.getElementById('detail-cadence-max');
                    if (avg && (!avg.textContent || avg.textContent === '-' )) avg.textContent = 'N/A';
                    if (max && (!max.textContent || max.textContent === '-' )) max.textContent = 'N/A';
                } else {
                    if (cadenceChartWrap) cadenceChartWrap.classList.remove('hidden');
                    if (cadenceMetrics) cadenceMetrics.classList.remove('opacity-60');
                    const note = cadenceMetrics ? cadenceMetrics.querySelector('[data-missing-note]') : null;
                    if (note) note.remove();
                }
            } catch (e) {
                console.warn('handleMissingMetrics failed:', e);
            }
        }

        function createCharts(chartData) {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';
            
            // Prepare time labels (every 10th point for readability)
            const timeLabels = chartData.timestamps.map((timestamp, index) => {
                if (index % 10 === 0) {
                    return new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
                return '';
            });
            
            const baseConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 0
                        }
                    }
                }
            };

            if (chartData.heart_rate.some(hr => hr !== null)) {
                const ctx1 = document.getElementById('heart-rate-chart').getContext('2d');
                chartInstances.heartRate = new Chart(ctx1, {
                    ...baseConfig,
                    data: {
                        labels: timeLabels,
                        datasets: [{
                            label: 'Heart Rate',
                            data: chartData.heart_rate,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            borderWidth: 2,
                            tension: 0.1
                        }]
                    }
                });
            }

            if (chartData.speed.some(speed => speed !== null)) {
                const speedKmh = chartData.speed.map(speed => speed ? speed * 3.6 : null);
                const ctx2 = document.getElementById('speed-chart').getContext('2d');
                chartInstances.speed = new Chart(ctx2, {
                    ...baseConfig,
                    data: {
                        labels: timeLabels,
                        datasets: [{
                            label: 'Speed',
                            data: speedKmh,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            borderWidth: 2,
                            tension: 0.1
                        }]
                    }
                });
            }

            if (chartData.power.some(power => power !== null)) {
                const ctx3 = document.getElementById('power-chart').getContext('2d');
                chartInstances.power = new Chart(ctx3, {
                    ...baseConfig,
                    data: {
                        labels: timeLabels,
                        datasets: [{
                            label: 'Power',
                            data: chartData.power,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true,
                            borderWidth: 2,
                            tension: 0.1
                        }]
                    }
                });
            }

            if (chartData.cadence.some(cadence => cadence !== null)) {
                const ctx4 = document.getElementById('cadence-chart').getContext('2d');
                chartInstances.cadence = new Chart(ctx4, {
                    ...baseConfig,
                    data: {
                        labels: timeLabels,
                        datasets: [{
                            label: 'Cadence',
                            data: chartData.cadence,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            borderWidth: 2,
                            tension: 0.1
                        }]
                    }
                });
            }
        }

        document.getElementById('close-modal').addEventListener('click', closeWorkoutModal);
        document.getElementById('close-modal-footer').addEventListener('click', closeWorkoutModal);
        document.getElementById('workout-modal').addEventListener('click', (e) => {
            if (e.target.id === 'workout-modal') {
                closeWorkoutModal();
            }
        });

        function closeWorkoutModal() {
            document.getElementById('workout-modal').classList.add('hidden');
        }

        let currentWorkoutId = null;
        
        function setupDeleteButton(workoutId) {
            currentWorkoutId = workoutId;
            const deleteBtn = document.getElementById('delete-workout-btn');
            
            const newDeleteBtn = deleteBtn.cloneNode(true);
            deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
            
            newDeleteBtn.addEventListener('click', async () => {
                const confirmed = confirm('Are you sure you want to delete this workout? This action cannot be undone and will remove all associated files.');
                
                if (confirmed) {
                    try {
                        newDeleteBtn.disabled = true;
                        newDeleteBtn.innerHTML = `
                            <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                                <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path>
                        </svg>
                        Deleting...
                        `;
                        
                        const response = await fetch(`/api/workouts/${workoutId}`, {
                            method: 'DELETE'
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to delete workout');
                        }
                        
                        const result = await response.json();
                        
                        closeWorkoutModal();
                        
                        showNotification('Workout deleted successfully', 'success');
                        
                        await loadWorkouts(1);
                        
                    } catch (error) {
                        console.error('Error deleting workout:', error);
                        showNotification(`Error deleting workout: ${error.message}`, 'error');
                        
                        // Reset button
                        newDeleteBtn.disabled = false;
                        newDeleteBtn.innerHTML = `
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Delete Workout
                        `;
                    }
                }
            });
        }

        async function setupTagsEditor(workout) {
            const container = document.getElementById('tags-current');
            const presetWrap = document.getElementById('preset-tags');
            const input = document.getElementById('custom-tag-input');
            const addBtn = document.getElementById('add-custom-tag');

            let tags = [];
            try { tags = Array.isArray(workout.tags) ? workout.tags : (workout.tags ? JSON.parse(workout.tags) : []); } catch { tags = []; }

            const render = () => {
                container.innerHTML = '';
                tags.forEach((t, idx) => {
                    container.appendChild(createTagChip(t, { removable: true, onRemove: () => { tags.splice(idx,1); save(); } }));
                });

                presetWrap.innerHTML = '';
                PRESET_TAGS.forEach(pt => {
                    const already = tags.map(s=>s.toLowerCase()).includes(pt.toLowerCase());
                    const btn = document.createElement('button');
                    btn.className = `px-2 py-1 text-xs rounded-full border ${already ? 'bg-primary-50/70 dark:bg-gray-800/60 text-primary-700 dark:text-primary-300 border-primary-500/30 dark:border-primary-600/40' : 'bg-white/80 dark:bg-gray-900/50 text-gray-700 dark:text-gray-200 border-gray-200/60 dark:border-gray-700/60'}`;
                    btn.textContent = pt;
                    btn.addEventListener('click', async () => {
                        if (already) return;
                        tags.push(pt);
                        await save();
                    });
                    presetWrap.appendChild(btn);
                });
            };

            const save = async () => {
                try {
                    const resp = await fetch(`/api/workouts/${workout.id}/tags`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tags }) });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to save tags');
                    tags = data.tags || [];
                    render();
                    try {
                        (tags || []).forEach(t => { if (typeof t === 'string' && t.trim()) knownTagSet.add(t.trim()); });
                        renderTagFilterBar();
                    } catch {}
                    await loadWorkouts(currentPage);
                    showNotification('Tags updated', 'success');
                } catch (e) {
                    console.error('Save tags failed', e);
                    showNotification(`Failed to update tags: ${e.message}`, 'error');
                }
            };

            addBtn.onclick = async () => {
                const val = (input.value || '').trim();
                if (!val) return;
                if (!tags.map(s=>s.toLowerCase()).includes(val.toLowerCase())) {
                    tags.push(val);
                    await save();
                }
                input.value = '';
            };

            input.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addBtn.click();
                }
            });

            render();
        }

        let activeTagFilter = '';
        
        // Pagination variables
        let currentPage = 1;
        let totalWorkouts = 0;
        const workoutsPerPage = 15;
        
        function renderTagFilterBar() {
            const bar = document.getElementById('tag-filter-chips');
            if (!bar) return;
            bar.innerHTML = '';
            const allChip = document.createElement('button');
            allChip.className = `px-2 py-1 text-xs rounded-full border ${!activeTagFilter ? 'bg-primary-50/70 dark:bg-gray-800/60 text-primary-700 dark:text-primary-300 border-primary-500/30 dark:border-primary-600/40' : 'bg-white/80 dark:bg-gray-900/50 text-gray-700 dark:text-gray-200 border-gray-200/60 dark:border-gray-700/60'}`;
            allChip.textContent = 'All';
            allChip.onclick = () => { activeTagFilter=''; currentPage = 1; loadWorkouts(1); renderTagFilterBar(); };
            bar.appendChild(allChip);
            Array.from(knownTagSet).sort((a,b)=>a.localeCompare(b)).forEach(pt => {
                const btn = document.createElement('button');
                const active = activeTagFilter.toLowerCase() === pt.toLowerCase();
                btn.className = `px-2 py-1 text-xs rounded-full border ${active ? 'bg-primary-50/70 dark:bg-gray-800/60 text-primary-700 dark:text-primary-300 border-primary-500/30 dark:border-primary-600/40' : 'bg-white/80 dark:bg-gray-900/50 text-gray-700 dark:text-gray-200 border-gray-200/60 dark:border-gray-700/60'}`;
                btn.textContent = pt;
                btn.onclick = () => { activeTagFilter = pt; currentPage = 1; loadWorkouts(1); renderTagFilterBar(); };
                bar.appendChild(btn);
            });
        }

    function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 max-w-sm w-full px-4 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
                type === 'success' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 border border-green-200 dark:border-green-700' :
                type === 'error' ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 border border-red-200 dark:border-red-700' :
                type === 'warning' ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 border border-yellow-200 dark:border-yellow-700' :
                'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 border border-blue-200 dark:border-blue-700'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        ${type === 'success' ? `
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        ` : type === 'error' ? `
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        ` : type === 'warning' ? `
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.93 19h14.14c1.54 0 2.5-1.67 1.73-3L13.73 5c-.77-1.33-2.69-1.33-3.46 0L3.2 16c-.77 1.33 .19 3 1.73 3z"></path>
                            </svg>
                        ` : `
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m-1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        `}
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <div class="ml-4 flex-shrink-0">
                        <button class="text-current hover:opacity-75" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeWorkoutModal();
            }
        });

        document.getElementById('refresh-workouts').addEventListener('click', () => {
            currentPage = 1;
            loadWorkouts(1);
        });
        
        // Pagination event listeners
        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                loadWorkouts(currentPage - 1);
            }
        });
        
        document.getElementById('next-page').addEventListener('click', () => {
            const totalPages = Math.ceil(totalWorkouts / workoutsPerPage);
            if (currentPage < totalPages) {
                loadWorkouts(currentPage + 1);
            }
        });

    renderTagFilterBar();
    loadWorkouts(1);
    loadMonthlySummary();
    loadContributionCalendar();

        const dropZone = document.querySelector('main');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('ring-2', 'ring-primary-500', 'ring-inset', 'bg-primary-50/50', 'dark:bg-primary-900/20');
        }

        function unhighlight(e) {
            dropZone.classList.remove('ring-2', 'ring-primary-500', 'ring-inset', 'bg-primary-50/50', 'dark:bg-primary-900/20');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            fileInput.files = files;
            handleFileSelection({ target: { files: files } });
        }
    </script>
    </div>
</body>
</html>
