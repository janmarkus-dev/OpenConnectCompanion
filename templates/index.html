<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenConnect Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full bg-gradient-to-b from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-950 transition-colors duration-200">
    <!-- Header -->
    <header class="bg-white/80 dark:bg-gray-900/60 backdrop-blur-sm shadow-sm border-b border-white/60 dark:border-gray-700/60">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo/Title -->
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="leading-tight">
                            <span class="block text-2xl sm:text-3xl font-extrabold tracking-tight bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">OpenConnect</span>
                            <span class="mt-0.5 inline-block text-xs sm:text-sm font-medium tracking-wide bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">Companion</span>
                        </div>
                    </div>
                </div>
                
                <!-- Upload and Theme Toggle Controls -->
                <div class="flex items-center space-x-3">
                    <!-- Compact Upload Button -->
                    <div class="relative">
                        <input id="fit-file-upload" name="fit_file" type="file" class="sr-only" accept=".fit" multiple>
                        <label for="fit-file-upload" class="inline-flex items-center px-3 py-2 border border-white/60 dark:border-gray-700/60 text-sm font-medium rounded-md text-gray-800 dark:text-gray-200 bg-white/70 dark:bg-gray-900/50 hover:bg-white/80 dark:hover:bg-gray-800/60 transition-colors duration-200 cursor-pointer backdrop-blur-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Upload FIT
                        </label>
                    </div>
                    
                    <!-- Garmin Device Upload Button -->
                    <button id="garmin-upload-btn" class="inline-flex items-center px-3 py-2 border border-orange-300/70 dark:border-orange-600/70 text-sm font-medium rounded-md text-orange-700 dark:text-orange-300 bg-orange-50/70 dark:bg-orange-900/20 hover:bg-orange-100/80 dark:hover:bg-orange-900/40 transition-colors duration-200 backdrop-blur-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Sync Garmin
                    </button>
                    
                    <!-- Dark/Light Mode Toggle -->
                <button 
                    id="theme-toggle" 
                    class="p-2 rounded-lg border border-gray-200/60 dark:border-gray-700/60 bg-white/70 dark:bg-gray-900/50 hover:bg-white/80 dark:hover:bg-gray-800/60 transition-colors duration-200 backdrop-blur-sm"
                    aria-label="Toggle theme"
                >
                    <!-- Sun Icon (Light Mode) -->
                    <svg id="sun-icon" class="w-5 h-5 text-gray-600 dark:text-gray-300 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <!-- Moon Icon (Dark Mode) -->
                    <svg id="moon-icon" class="w-5 h-5 text-gray-600 dark:text-gray-300 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <!-- Welcome Section -->
            <div class="rounded-2xl mb-6">
                <div class="p-[1px] rounded-2xl bg-gradient-to-r from-gray-200/60 via-gray-100/40 to-gray-200/60 dark:from-gray-700/60 dark:via-gray-800/60 dark:to-gray-700/60">
                    <div class="rounded-[15px] p-4 bg-white/80 dark:bg-gray-900/50 backdrop-blur-sm">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <!-- Subtle icon like in workout summary -->
                                <div class="w-9 h-9 rounded-md bg-indigo-500/10 border border-indigo-200/60 dark:border-indigo-800/60 text-indigo-600 dark:text-indigo-300 flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-4">
                                <h2 class="text-lg font-medium text-gray-900 dark:text-white">
                                    Garmin Data Synchronization
                                </h2>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    Blazing fast, open source, local, self-hostable Garmin Connect alternative
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Summary - Minimal One Row Layout -->
            <div class="rounded-2xl mb-6"></div>
                <div class="p-[1px] rounded-2xl bg-gradient-to-r from-blue-200/60 via-sky-200/60 to-emerald-200/60 dark:from-gray-700/70 dark:via-gray-800/70 dark:to-gray-700/70">
                    <div class="px-4 py-3 rounded-[15px] bg-white/80 dark:bg-gray-900/40 backdrop-blur-sm">
                        <div class="flex items-center justify-between gap-4">
                            <!-- Month title -->
                            <div class="flex items-center gap-2 min-w-[160px]">
                                <div class="w-7 h-7 rounded-md bg-indigo-500/10 border border-indigo-200/60 dark:border-indigo-800/60 text-indigo-600 dark:text-indigo-300 flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3M5 11h14M5 19h14M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z"/></svg>
                                </div>
                                <div>
                                    <p class="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400">This Month</p>
                                    <p id="month-range" class="text-sm font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">-</p>
                                </div>
                            </div>

                            <!-- Workouts count -->
                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 rounded-md bg-blue-500/10 border border-blue-200/60 dark:border-blue-800/60 text-blue-600 dark:text-blue-300 flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18M13 13v5M9 9v9M17 7v11"/></svg>
                                </div>
                                <div>
                                    <p class="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400">Workouts</p>
                                    <p id="monthly-workouts" class="text-sm font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">0</p>
                                </div>
                            </div>

                            <!-- Distance -->
                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 rounded-md bg-emerald-500/10 border border-emerald-200/60 dark:border-emerald-800/60 text-emerald-600 dark:text-emerald-300 flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="9" r="4" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22s8-4.5 8-12a8 8 0 10-16 0c0 7.5 8 12 8 12z"/></svg>
                                </div>
                                <div>
                                    <p class="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400">Distance</p>
                                    <p id="monthly-distance" class="text-sm font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">0 km</p>
                                </div>
                            </div>

                            <!-- Duration -->
                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 rounded-md bg-amber-500/10 border border-amber-200/60 dark:border-amber-800/60 text-amber-600 dark:text-amber-300 flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </div>
                                <div>
                                    <p class="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400">Duration</p>
                                    <p id="monthly-duration" class="text-sm font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">0m</p>
                                </div>
                            </div>

                            <!-- Calories -->
                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 rounded-md bg-rose-500/10 border border-rose-200/60 dark:border-rose-800/60 text-rose-600 dark:text-rose-300 flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                </div>
                                <div>
                                    <p class="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400">Calories</p>
                                    <p id="monthly-calories" class="text-sm font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">0 kcal</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Workouts -->
            <div class="rounded-2xl">
                <div class="p-[1px] rounded-2xl bg-gradient-to-r from-gray-200/60 via-gray-100/40 to-gray-200/60 dark:from-gray-700/60 dark:via-gray-800/60 dark:to-gray-700/60">
                    <div class="rounded-[15px] p-4 bg-white/80 dark:bg-gray-900/50 backdrop-blur-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Recent Workouts</h3>
                        <button id="refresh-workouts" class="text-primary-600 hover:text-primary-700 text-sm font-medium">
                            Refresh
                        </button>
                    </div>
                    
                    <!-- Compact Upload Status -->
                    <div id="upload-status" class="hidden mb-4 p-3 rounded-md text-sm"></div>
                    
                    <!-- Compact File List -->
                    <div id="file-list" class="hidden mb-4">
                        <div class="p-[1px] rounded-xl bg-gradient-to-r from-gray-200/60 via-gray-100/40 to-gray-200/60 dark:from-gray-700/60 dark:via-gray-800/60 dark:to-gray-700/60">
                            <div class="rounded-[12px] p-3 bg-white/80 dark:bg-gray-900/50 backdrop-blur-sm border border-white/60 dark:border-gray-700/60">
                                <div class="flex items-center mb-2">
                                    <div class="w-6 h-6 rounded-md bg-primary-500/10 border border-primary-500/30 dark:border-primary-600/40 text-primary-600 dark:text-primary-400 flex items-center justify-center mr-2">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                    </div>
                                    <h4 class="text-sm font-medium bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">Selected Files</h4>
                                    <button id="upload-btn" class="ml-auto inline-flex items-center px-3 py-1.5 border border-primary-500/30 dark:border-primary-600/40 text-xs font-semibold rounded-md text-primary-700 dark:text-primary-300 bg-white/80 dark:bg-gray-900/50 hover:bg-primary-50/80 dark:hover:bg-gray-800/60 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200">
                                        <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                        </svg>
                                        Upload
                                    </button>
                                </div>
                                <ul id="selected-files" class="space-y-1 text-sm"></ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Workouts List -->
                    <div id="workouts-list" class="space-y-2">
                        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                            Loading workouts...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Workout Details Modal -->
    <div id="workout-modal" class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm overflow-y-auto h-full w-full z-50">
        <div class="relative top-8 mx-auto p-4 md:p-5 border w-11/12 md:w-5/6 lg:w-4/5 xl:w-3/4 2xl:w-2/3 shadow-xl rounded-2xl bg-white/90 dark:bg-gray-900/70 border-white/60 dark:border-gray-700/60 max-w-6xl">
            <!-- Modal Header -->
            <div class="flex items-center justify-between pb-3 border-b border-gray-200/60 dark:border-gray-700/60">
                <h3 id="modal-title" class="text-base md:text-lg font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">Workout Details</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div id="modal-content" class="pt-3 max-h-[80vh] overflow-y-auto">
                <!-- Collapsible Route Map (Folium iframe) -->
                <section id="route-map-section" class="mb-6 hidden">
                    <div class="relative rounded-xl border border-gray-200/60 dark:border-gray-700/60 overflow-hidden">
                        <div id="route-map-container" class="relative h-48 md:h-64 bg-gray-100 dark:bg-gray-700">
                            <!-- Map iframe -->
                            <iframe id="route-map-iframe" title="Route Map" class="w-full h-full block" src="about:blank" loading="lazy"></iframe>
                            
                            <!-- Fade overlay for half-collapsed look -->
                            <div id="route-map-fade" class="pointer-events-none absolute inset-x-0 bottom-0 h-16 bg-gradient-to-t from-white/90 via-white/60 to-transparent dark:from-gray-800/90 dark:via-gray-800/60 transition-opacity"></div>
                            
                            <!-- Expand/Collapse button -->
                            <button id="toggle-map-size" class="absolute bottom-3 right-3 inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md bg-white/90 dark:bg-gray-900/70 text-gray-800 dark:text-gray-200 border border-gray-200 dark:border-gray-700 shadow-sm backdrop-blur hover:bg-white dark:hover:bg-gray-800 transition">
                                <svg id="toggle-icon" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14m-7-7h14"/></svg>
                                <span id="toggle-map-label">Expand map</span>
                            </button>
                        </div>
                    </div>
                </section>
                <!-- Loading state -->
                <div id="modal-loading" class="flex items-center justify-center py-8">
                    <svg class="animate-spin w-8 h-8 text-primary-600" fill="none" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                        <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path>
                    </svg>
                    <span class="ml-2 text-gray-600 dark:text-gray-400">Loading workout details...</span>
                </div>
                
                <!-- Content will be populated dynamically -->
                <div id="modal-workout-data" class="hidden">
                    <!-- Basic Info Section -->
                    <div class="mb-4">
                        <h4 class="text-sm md:text-md font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2">Basic Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="bg-white/70 dark:bg-gray-800/40 p-2 rounded-md border border-gray-200/60 dark:border-gray-700/60">
                                <span class="block text-xs font-medium text-gray-500 dark:text-gray-400">Activity Type</span>
                                <span id="detail-workout-type" class="text-sm font-semibold text-gray-900 dark:text-white">-</span>
                            </div>
                            <div class="bg-white/70 dark:bg-gray-800/40 p-2 rounded-md border border-gray-200/60 dark:border-gray-700/60">
                                <span class="block text-xs font-medium text-gray-500 dark:text-gray-400">Start Time</span>
                                <span id="detail-start-time" class="text-sm font-semibold text-gray-900 dark:text-white">-</span>
                            </div>
                            <div class="bg-white/70 dark:bg-gray-800/40 p-2 rounded-md border border-gray-200/60 dark:border-gray-700/60">
                                <span class="block text-xs font-medium text-gray-500 dark:text-gray-400">Duration</span>
                                <span id="detail-duration" class="text-sm font-semibold text-gray-900 dark:text-white">-</span>
                            </div>
                            <div class="bg-white/70 dark:bg-gray-800/40 p-2 rounded-md border border-gray-200/60 dark:border-gray-700/60">
                                <span class="block text-xs font-medium text-gray-500 dark:text-gray-400">Distance</span>
                                <span id="detail-distance" class="text-sm font-semibold text-gray-900 dark:text-white">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Metrics -->
                    <div class="mb-4">
                        <h4 class="text-sm md:text-md font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2">Performance Metrics</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <!-- Heart Rate -->
                            <div class="p-2 rounded-md border border-red-200/60 dark:border-red-800/60 bg-gradient-to-br from-white/85 to-red-50/60 dark:from-gray-900/30 dark:to-red-900/10">
                                <div class="flex items-center mb-2">
                                    <svg class="w-4 h-4 text-red-600 dark:text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-xs font-medium text-red-700 dark:text-red-300">Heart Rate</span>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex justify-between text-xs">
                                        <span class="text-red-600 dark:text-red-400">Avg:</span>
                                        <span id="detail-hr-avg" class="font-semibold text-red-900 dark:text-red-100">-</span>
                                    </div>
                                    <div class="flex justify-between text-xs">
                                        <span class="text-red-600 dark:text-red-400">Max:</span>
                                        <span id="detail-hr-max" class="font-semibold text-red-900 dark:text-red-100">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Power -->
                            <div id="power-metrics-container" class="p-2 rounded-md border border-yellow-200/60 dark:border-yellow-800/60 bg-gradient-to-br from-white/85 to-yellow-50/60 dark:from-gray-900/30 dark:to-yellow-900/10">
                                <div class="flex items-center mb-2">
                                    <svg class="w-4 h-4 text-yellow-600 dark:text-yellow-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    <span class="text-xs font-medium text-yellow-700 dark:text-yellow-300">Power</span>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex justify-between text-xs">
                                        <span class="text-yellow-600 dark:text-yellow-400">Avg:</span>
                                        <span id="detail-power-avg" class="font-semibold text-yellow-900 dark:text-yellow-100">-</span>
                                    </div>
                                    <div class="flex justify-between text-xs">
                                        <span class="text-yellow-600 dark:text-yellow-400">Max:</span>
                                        <span id="detail-power-max" class="font-semibold text-yellow-900 dark:text-yellow-100">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cadence -->
                            <div class="p-2 rounded-md border border-blue-200/60 dark:border-blue-800/60 bg-gradient-to-br from-white/85 to-blue-50/60 dark:from-gray-900/30 dark:to-blue-900/10">
                                <div class="flex items-center mb-2">
                                    <svg class="w-4 h-4 text-blue-600 dark:text-blue-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    <span class="text-xs font-medium text-blue-700 dark:text-blue-300">Cadence</span>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex justify-between text-xs">
                                        <span class="text-blue-600 dark:text-blue-400">Avg:</span>
                                        <span id="detail-cadence-avg" class="font-semibold text-blue-900 dark:text-blue-100">-</span>
                                    </div>
                                    <div class="flex justify-between text-xs">
                                        <span class="text-blue-600 dark:text-blue-400">Max:</span>
                                        <span id="detail-cadence-max" class="font-semibold text-blue-900 dark:text-blue-100">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Speed -->
                            <div class="p-2 rounded-md border border-green-200/60 dark:border-green-800/60 bg-gradient-to-br from-white/85 to-green-50/60 dark:from-gray-900/30 dark:to-green-900/10">
                                <div class="flex items-center mb-2">
                                    <svg class="w-4 h-4 text-green-600 dark:text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="text-xs font-medium text-green-700 dark:text-green-300">Speed</span>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex justify-between text-xs">
                                        <span class="text-green-600 dark:text-green-400">Avg:</span>
                                        <span id="detail-speed-avg" class="font-semibold text-green-900 dark:text-green-100">-</span>
                                    </div>
                                    <div class="flex justify-between text-xs">
                                        <span class="text-green-600 dark:text-green-400">Max:</span>
                                        <span id="detail-speed-max" class="font-semibold text-green-900 dark:text-green-100">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Calories -->
                            <div class="p-2 rounded-md border border-purple-200/60 dark:border-purple-800/60 bg-gradient-to-br from-white/85 to-purple-50/60 dark:from-gray-900/30 dark:to-purple-900/10">
                                <div class="flex items-center mb-2">
                                    <svg class="w-4 h-4 text-purple-600 dark:text-purple-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path>
                                    </svg>
                                    <span class="text-xs font-medium text-purple-700 dark:text-purple-300">Calories</span>
                                </div>
                                <div class="text-center">
                                    <span id="detail-calories" class="text-lg font-semibold text-purple-900 dark:text-purple-100">-</span>
                                </div>
                            </div>
                            
                            <!-- Elevation -->
                            <div class="p-2 rounded-md border border-gray-200/60 dark:border-gray-600/60 bg-gradient-to-br from-white/85 to-gray-50/60 dark:from-gray-900/30 dark:to-gray-800/20">
                                <div class="flex items-center mb-2">
                                    <svg class="w-4 h-4 text-gray-600 dark:text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                    </svg>
                                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Elevation</span>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex justify-between text-xs">
                                        <span class="text-gray-600 dark:text-gray-400">Gain:</span>
                                        <span id="detail-elevation-gain" class="font-semibold text-gray-900 dark:text-gray-100">-</span>
                                    </div>
                                    <div class="flex justify-between text-xs">
                                        <span class="text-gray-600 dark:text-gray-400">Loss:</span>
                                        <span id="detail-elevation-loss" class="font-semibold text-gray-900 dark:text-gray-100">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Charts -->
                    <div class="mb-4">
                        <h4 class="text-sm md:text-md font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2">Performance Charts</h4>
                        
                        <!-- Charts Container -->
                        <div id="charts-container">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <!-- Heart Rate Chart -->
                                <div class="bg-white/80 dark:bg-gray-900/40 border border-gray-200/60 dark:border-gray-700/60 rounded-lg p-3 shadow-sm">
                                    <h5 class="text-sm font-medium bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2 flex items-center">
                                        <svg class="w-4 h-4 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
                                        </svg>
                                        Heart Rate (bpm)
                                    </h5>
                                    <div class="h-48">
                                        <canvas id="heart-rate-chart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Speed Chart -->
                                <div class="bg-white/80 dark:bg-gray-900/40 border border-gray-200/60 dark:border-gray-700/60 rounded-lg p-3 shadow-sm">
                                    <h5 class="text-sm font-medium bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2 flex items-center">
                                        <svg class="w-4 h-4 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Speed (km/h)
                                    </h5>
                                    <div class="h-48">
                                        <canvas id="speed-chart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Power Chart -->
                                <div id="power-chart-container" class="bg-white/80 dark:bg-gray-900/40 border border-gray-200/60 dark:border-gray-700/60 rounded-lg p-3 shadow-sm">
                                    <h5 class="text-sm font-medium bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2 flex items-center">
                                        <svg class="w-4 h-4 text-yellow-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                        Power (watts)
                                    </h5>
                                    <div class="h-48">
                                        <canvas id="power-chart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Cadence Chart -->
                                <div class="bg-white/80 dark:bg-gray-900/40 border border-gray-200/60 dark:border-gray-700/60 rounded-lg p-3 shadow-sm">
                                    <h5 class="text-sm font-medium bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2 flex items-center">
                                        <svg class="w-4 h-4 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Cadence (rpm)
                                    </h5>
                                    <div class="h-48">
                                        <canvas id="cadence-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="charts-loading" class="hidden text-center py-8">
                            <svg class="animate-spin w-8 h-8 mx-auto text-primary-600" fill="none" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                                <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path>
                            </svg>
                            <span class="block mt-2 text-sm text-gray-600 dark:text-gray-400">Loading charts...</span>
                        </div>
                    </div>
                    
                    <!-- File Information -->
                    <div class="mb-4">
                        <h4 class="text-sm md:text-md font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent mb-2">File Information</h4>
                        <div class="bg-white/70 dark:bg-gray-800/40 p-2 rounded-md border border-gray-200/60 dark:border-gray-700/60">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">Filename:</span>
                                    <span id="detail-filename" class="font-medium text-gray-900 dark:text-white">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">Upload Date:</span>
                                    <span id="detail-upload-date" class="font-medium text-gray-900 dark:text-white">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">Status:</span>
                                    <span id="detail-status" class="font-medium text-gray-900 dark:text-white">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">File Hash:</span>
                                    <span id="detail-hash" class="font-mono text-xs text-gray-900 dark:text-white">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    

                    
                    <!-- Modal Footer -->
            <div class="px-4 py-3 bg-white/70 dark:bg-gray-800/40 border-t border-gray-200/60 dark:border-gray-700/60 flex justify-between items-center rounded-b-2xl">
                        <button 
                            id="delete-workout-btn" 
                class="inline-flex items-center px-3 py-1.5 border border-red-300/70 dark:border-red-600/70 text-sm font-medium rounded-md text-red-700 dark:text-red-400 bg-white/80 dark:bg-gray-900/50 hover:bg-red-50/80 dark:hover:bg-red-900/30 transition-colors duration-200"
                        >
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Delete Workout
                        </button>
                        
                        <button 
                            id="close-modal-footer" 
                class="inline-flex items-center px-3 py-1.5 border border-gray-300/70 dark:border-gray-600/70 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white/80 dark:bg-gray-900/50 hover:bg-gray-50/80 dark:hover:bg-gray-800/60 transition-colors duration-200"
                        >
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white/80 dark:bg-gray-900/60 backdrop-blur-sm border-t border-white/60 dark:border-gray-700/60">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-sm text-gray-500 dark:text-gray-400">
                <a href="https://github.com/janmarkus-dev/OpenConnectCompanion" target="_blank" rel="noopener noreferrer" class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 underline">
                    OpenConnect Companion
                </a> - Independent open-source project, not affiliated with Garmin Ltd.
            </p>
        </div>
    </footer>

    <script>
        // Timezone utilities
        let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        let serverTimezoneInfo = null;

        // Fetch server timezone information
        async function initializeTimezone() {
            try {
                const response = await fetch('/api/timezone');
                if (response.ok) {
                    serverTimezoneInfo = await response.json();
                    console.log('Server timezone:', serverTimezoneInfo.timezone_name);
                    console.log('User timezone:', userTimezone);
                }
            } catch (error) {
                console.warn('Could not fetch server timezone info:', error);
            }
        }

        // Convert timestamp to local timezone for display
        function formatTimeForDisplay(timestamp) {
            if (!timestamp) return 'Unknown';
            try {
                const date = new Date(timestamp);
                return date.toLocaleString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short'
                });
            } catch (error) {
                console.warn('Error formatting timestamp:', error);
                return timestamp;
            }
        }

        // Convert timestamp to local date for display
        function formatDateForDisplay(timestamp) {
            if (!timestamp) return 'Unknown';
            try {
                const date = new Date(timestamp);
                return date.toLocaleDateString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                console.warn('Error formatting date:', error);
                return timestamp;
            }
        }

        // Format activity type with proper capitalization
        function formatActivityType(activityType) {
            if (!activityType || activityType === 'Unknown') return 'Unknown';
            
            // Split by underscores or spaces and capitalize each word
            return activityType
                .split(/[_\s]+/)
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

    // Get workout type icon and color (Font Awesome icons embedded locally)
        function getWorkoutTypeIcon(activityType) {
            if (!activityType) activityType = 'unknown';
            const type = activityType.toLowerCase();
            
            // Common workout type mappings with Font Awesome icons
            if (type.includes('cycling') || type.includes('bike') || type.includes('biking')) {
                return {
                    icon: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 640 512">
                        <path d="M312 32c-13.3 0-24 10.7-24 24s10.7 24 24 24h25.7l34.6 64H222.9l-27.4-38C191 99.7 183.7 96 176 96H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h43.7l22.1 30.7-26.6 53.1c-10-2.5-20.5-3.8-31.2-3.8C57.3 224 0 281.3 0 352s57.3 128 128 128c65.3 0 119.1-48.9 127-112h49c7.9 63.1 61.7 112 127 112c70.7 0 128-57.3 128-128s-57.3-128-128-128c-13.5 0-26.5 2.1-38.7 6L375.4 48.8C369.8 38.4 359 32 347.2 32H312zM458.6 303.7l32.3 64.5c1.7 3.4 6.1 6.2 11.2 6.2c6.5 0 11.7-5.2 11.7-11.7c0-1.7-.4-3.3-1.1-4.6l-32.2-64.5C491.8 297.1 475.2 300 458.6 303.7zM128 288a64 64 0 1 1 0 128 64 64 0 1 1 0-128zm256 64a64 64 0 1 1 128 0 64 64 0 1 1 -128 0z"/>
                    </svg>`,
            color: 'text-blue-600 dark:text-blue-300',
            bgColor: 'bg-blue-500/10 border border-blue-200/60 dark:border-blue-800/60'
                };
            }
            
            if (type.includes('running') || type.includes('run') || type.includes('jog')) {
                return {
                    icon: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 448 512">
                        <path d="M320 48a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM125.7 175.5c9.9-9.9 23.4-15.5 37.5-15.5c1.9 0 3.8 .1 5.6 .3L137.6 254c-9.3 28.1-33.7 47.3-62.2 48.6c-15 .7-30.8-2.9-43.9-12.6C9.3 276.2-2.4 249-2.4 249s27.2-11.7 41-27.5c13.9-15.9 14.6-33.9 16.7-40.9c4.4-14.9 15.2-26.3 29.5-31.8c14.3-5.5 30.7-2.8 42.4 6.8zM173.3 148.7c2 1.9 4.7 2.8 7.5 2.8c2.6 0 5.1-.7 7.2-2.2l115.6-81.6c5.2-3.7 12.6-2.5 16.3 2.6s2.5 12.6-2.6 16.3L201.7 167.9c-9.1 6.4-20.9 5.3-28.6-2.3c-7.8-7.8-7.8-20.5 0-28.3zM126.6 231.5l-25.9 77.8c-1.6 4.7-5.4 8.4-10.2 9.9l-48.8 15.1c-7.2 2.2-14.9-1.8-17.1-9s1.8-14.9 9-17.1l41.7-12.9L101.7 213c7.5-22.5 30.3-36.7 54.4-34l47.4 5.3c13.3 1.5 26-4.8 33.2-16.3l23.7-37.2c4.4-6.9 13.8-9.1 20.7-4.7s9.1 13.8 4.7 20.7l-23.7 37.2c-13.9 21.8-38.2 34.9-63.9 34.5l-9.7-1.1c-5.1-.6-9.4 3.1-10 8.1s3.1 9.4 8.1 10l9.7 1.1c35.8 4 68.9-15.9 87.4-52.4l23.7-37.2c10.4-16.3 32.8-21.1 49.1-10.7s21.1 32.8 10.7 49.1l-23.7 37.2c-24.4 38.3-67.7 58.6-113.4 53.4c-13.2-1.5-26.3 5.4-32.6 17.1L89 409.5c-3.5 6.5-11.6 8.9-18.1 5.4s-8.9-11.6-5.4-18.1L87.9 342c11.2-20.9 35.5-31.5 58.6-25.6c20.1 5.1 41.2-6.2 47.9-25.6l9.5-27.6c1.4-4 .1-8.5-3.2-11.1s-8.2-2.4-11.7 .2L126.6 231.5z"/>
                    </svg>`,
                    color: 'text-emerald-600 dark:text-emerald-300',
                    bgColor: 'bg-emerald-500/10 border border-emerald-200/60 dark:border-emerald-800/60'
                };
            }
            
            if (type.includes('swimming') || type.includes('swim')) {
                return {
                    icon: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 576 512">
                        <path d="M309.5 178.4L447.9 297.1c-1.6 .9-3.2 2-4.8 3.1c-18.1 12.4-40.1 12.4-58.2 0c-18.1-12.4-40.1-12.4-58.2 0c-18.1 12.4-40.1 12.4-58.2 0c-18.1-12.4-40.1-12.4-58.2 0c-18.1 12.4-40.1 12.4-58.2 0c-18.1-12.4-40.1-12.4-58.2 0c-1.5-1-3.1-2.1-4.6-3L128.1 178.4c0 0 0 0 0 0s0 0 0 0c2.1 1.4 4.2 2.7 6.4 3.9c18.1 12.4 40.1 12.4 58.2 0c18.1-12.4 40.1-12.4 58.2 0c18.1 12.4 40.1 12.4 58.2 0s40.1-12.4 58.2 0c2.2-1.2 4.3-2.5 6.4-3.9zm234.7 60.5c18.1 12.4 40.1 12.4 58.2 0c8.1-5.6 19.2-3.7 24.8 4.4s3.7 19.2-4.4 24.8c-9.5 6.5-20.3 9.7-31.1 9.7s-21.6-3.2-31.1-9.7c-6.6-4.5-14.7-4.5-21.2 0c-9.5 6.5-20.3 9.7-31.1 9.7s-21.6-3.2-31.1-9.7c-6.6-4.5-14.7-4.5-21.2 0c-9.5 6.5-20.3 9.7-31.1 9.7s-21.6-3.2-31.1-9.7c-6.6-4.5-14.7-4.5-21.2 0c-9.5 6.5-20.3 9.7-31.1 9.7s-21.6-3.2-31.1-9.7c-6.6-4.5-14.7-4.5-21.2 0c-9.5 6.5-20.3 9.7-31.1 9.7s-21.6-3.2-31.1-9.7c-6.6-4.5-14.7-4.5-21.2 0c-9.5 6.5-20.3 9.7-31.1 9.7s-21.6-3.2-31.1-9.7c-8.1-5.6-10-16.6-4.4-24.8s16.6-10 24.8-4.4c18.1 12.4 40.1 12.4 58.2 0c18.1-12.4 40.1-12.4 58.2 0c18.1 12.4 40.1 12.4 58.2 0c18.1-12.4 40.1-12.4 58.2 0c18.1 12.4 40.1 12.4 58.2 0c18.1-12.4 40.1-12.4 58.2 0zM0 395.3c18.1 12.4 40.1 12.4 58.2 0c18.1-12.4 40.1-12.4 58.2 0c18.1 12.4 40.1 12.4 58.2 0c18.1-12.4 40.1-12.4 58.2 0c18.1 12.4 40.1 12.4 58.2 0c18.1-12.4 40.1-12.4 58.2 0c18.1 12.4 40.1 12.4 58.2 0c8.1-5.6 19.2-3.7 24.8 4.4s3.7 19.2-4.4 24.8c-9.5 6.5-20.3 9.7-31.1 9.7s-21.6-3.2-31.1-9.7c-6.6-4.5-14.7-4.5-21.2 0c-9.5 6.5-20.3 9.7-31.1 9.7s-21.6-3.2-31.1-9.7c-6.6-4.5-14.7-4.5-21.2 0c-9.5 6.5-20.3 9.7-31.1 9.7s-21.6-3.2-31.1-9.7c-6.6-4.5-14.7-4.5-21.2 0c-9.5 6.5-20.3 9.7-31.1 9.7s-21.6-3.2-31.1-9.7c-6.6-4.5-14.7-4.5-21.2 0c-9.5 6.5-20.3 9.7-31.1 9.7s-21.6-3.2-31.1-9.7c-6.6-4.5-14.7-4.5-21.2 0c-9.5 6.5-20.3 9.7-31.1 9.7s-21.6-3.2-31.1-9.7c-8.1-5.6-10-16.6-4.4-24.8s16.6-10 24.8-4.4zM224 224a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm96-96a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/>
                    </svg>`,
                    color: 'text-cyan-600 dark:text-cyan-300',
                    bgColor: 'bg-cyan-500/10 border border-cyan-200/60 dark:border-cyan-800/60'
                };
            }
            
            if (type.includes('walking') || type.includes('walk') || type.includes('hiking') || type.includes('hike')) {
                return {
                    icon: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 320 512">
                        <path d="M160 48a48 48 0 1 1 0 96 48 48 0 1 1 0-96zM126.5 199.3c-1 .4-1.9 .8-2.9 1.2l-8 3.5c-16.4 7.3-29 21.2-34.7 38.2l-2.6 7.8c-5.6 16.8-23.7 25.8-40.5 20.2s-25.8-23.7-20.2-40.5l2.6-7.8c11.4-34.1 36.6-61.9 69.4-76.5l8-3.5c20.8-9.2 43.3-14 66.1-14c44.6 0 84.8 26.8 101.9 67.9L281 232.7l21.4 10.7c15.8 7.9 22.2 27.1 14.3 42.9s-27.1 22.2-42.9 14.3L247 287.3c-10.3-5.2-18.4-13.8-22.8-24.5l-9.6-23-19.3 65.5 49.5 54c5.4 5.9 9.2 13 11.2 20.8l23 92.1c4.3 17.1-6.1 34.5-23.3 38.8s-34.5-6.1-38.8-23.3l-22-88.1-70.7-77.1c-14.8-16.1-20.3-38.6-14.7-59.7l16.9-63.5zM68.7 398l25-62.4c2.1 3 4.5 5.8 7 8.6l40.7 44.4-14.5 36.2c-2.4 6-7 10.9-12.9 13.4l-15.8 6.8c-8.2 3.5-17.8 .3-21.4-7.9s-.3-17.8 7.9-21.4l15.8-6.8c1.8-.8 3.1-2.3 3.7-4.1z"/>
                    </svg>`,
                    color: 'text-teal-600 dark:text-teal-300',
                    bgColor: 'bg-teal-500/10 border border-teal-200/60 dark:border-teal-800/60'
                };
            }
            
            if (type.includes('strength') || type.includes('weight') || type.includes('training') || type.includes('gym')) {
                return {
                    icon: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 640 512">
                        <path d="M96 64c0-17.7 14.3-32 32-32h32c17.7 0 32 14.3 32 32V224v64V448c0 17.7-14.3 32-32 32H128c-17.7 0-32-14.3-32-32V384H64c-17.7 0-32-14.3-32-32V288c0-17.7 14.3-32 32-32H96V64zm448 0v192h32c17.7 0 32 14.3 32 32v64c0 17.7-14.3 32-32 32H544v64c0 17.7-14.3 32-32 32H480c-17.7 0-32-14.3-32-32V288 224 64c0-17.7 14.3-32 32-32h32c17.7 0 32 14.3 32 32zM416 224V288H224V224H416z"/>
                    </svg>`,
                    color: 'text-purple-600 dark:text-purple-300',
                    bgColor: 'bg-purple-500/10 border border-purple-200/60 dark:border-purple-800/60'
                };
            }
            
            // Default for unknown types
            return {
                icon: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 512 512">
                    <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/>
                </svg>`,
                color: 'text-gray-600 dark:text-gray-300',
                bgColor: 'bg-gray-500/10 border border-gray-300/60 dark:border-gray-700/60'
            };
        }

        // Initialize timezone on page load
        initializeTimezone();

        // Theme toggle functionality
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const html = document.documentElement;

        // Check for saved theme preference or default to light mode
        const currentTheme = localStorage.getItem('theme') || 'light';
        
        if (currentTheme === 'dark') {
            html.classList.add('dark');
        }

        themeToggle.addEventListener('click', () => {
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }

            // If the workout modal is open with a map, reload the iframe with new theme
            const modal = document.getElementById('workout-modal');
            const routeSection = document.getElementById('route-map-section');
            if (!modal.classList.contains('hidden') && routeSection && !routeSection.classList.contains('hidden')) {
                const iframe = document.getElementById('route-map-iframe');
                const src = new URL(iframe.src, window.location.origin);
                const newTheme = html.classList.contains('dark') ? 'dark' : 'light';
                src.searchParams.set('theme', newTheme);
                iframe.src = src.toString();
            }
        });

        // Apply saved theme on page load
        if (localStorage.getItem('theme') === 'dark') {
            html.classList.add('dark');
        }

        // File upload functionality
        // DOM elements
        const fileInput = document.getElementById('fit-file-upload');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadStatus = document.getElementById('upload-status');
        const fileList = document.getElementById('file-list');
        const selectedFiles = document.getElementById('selected-files');
        
        let filesToUpload = [];

        // Handle file selection
        fileInput.addEventListener('change', handleFileSelection);
        
        function handleFileSelection(event) {
            const files = Array.from(event.target.files);
            filesToUpload = files.filter(file => file.name.toLowerCase().endsWith('.fit'));
            
            if (filesToUpload.length > 0) {
                displaySelectedFiles();
                fileList.classList.remove('hidden');
            } else {
                fileList.classList.add('hidden');
            }
        }

        function displaySelectedFiles() {
            selectedFiles.innerHTML = '';
            filesToUpload.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between py-1 px-2 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-600';
                li.innerHTML = `
                    <span class="text-xs text-gray-700 dark:text-gray-300 truncate flex-1 mr-2">${file.name}</span>
                    <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 flex-shrink-0">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                selectedFiles.appendChild(li);
            });
        }

        function removeFile(index) {
            filesToUpload.splice(index, 1);
            if (filesToUpload.length > 0) {
                displaySelectedFiles();
            } else {
                fileList.classList.add('hidden');
            }
        }

        // Handle upload button click
        async function handleUpload() {
            if (filesToUpload.length === 0) {
                showStatus('Please select at least one FIT file.', 'error');
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<svg class="animate-spin w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path></svg>Uploading...';

            let successCount = 0;
            let errorCount = 0;
            let errorMessages = [];

            for (const file of filesToUpload) {
                try {
                    const formData = new FormData();
                    formData.append('fit_file', file);

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        successCount++;
                        console.log(`Successfully uploaded: ${file.name}`);
                    } else {
                        errorCount++;
                        const errorMsg = `${file.name}: ${result.error || 'Unknown error'}`;
                        errorMessages.push(errorMsg);
                        console.error(`Error uploading ${file.name}:`, result.error);
                    }
                } catch (error) {
                    errorCount++;
                    const errorMsg = `${file.name}: ${error.message}`;
                    errorMessages.push(errorMsg);
                    console.error(`Error uploading ${file.name}:`, error);
                }
            }

            // Reset form
            filesToUpload = [];
            fileInput.value = '';
            fileList.classList.add('hidden');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>Upload';

            // Show status
            if (successCount > 0 && errorCount === 0) {
                showStatus(`Successfully uploaded ${successCount} file(s).`, 'success');
                loadWorkouts(); // Refresh workout list
                loadStats(); // Refresh stats
            } else if (successCount > 0 && errorCount > 0) {
                showStatus(`Uploaded ${successCount} file(s), ${errorCount} failed.`, 'warning');
                loadWorkouts();
                loadStats();
            } else {
                showStatus(`Failed to upload ${errorCount} file(s). ${errorMessages.join('; ')}`, 'error');
            }
        }

        // Attach upload handler to button
        uploadBtn.addEventListener('click', handleUpload);

        // Garmin Device Sync functionality
        async function handleGarminSync() {
            const garminBtn = document.getElementById('garmin-upload-btn');
            
            // Disable button and show loading state
            garminBtn.disabled = true;
            const originalHTML = garminBtn.innerHTML;
            garminBtn.innerHTML = `
                <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                    <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path>
                </svg>
                Syncing...
            `;

            try {
                const response = await fetch('/api/devices/scan-fit-files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                // Show appropriate status message
                if (result.devices_scanned === 0) {
                    showStatus('No Garmin devices detected. Make sure your device is connected and mounted.', 'warning');
                } else if (result.files_uploaded > 0) {
                    const message = `Successfully synced ${result.files_uploaded} workout(s) from your Garmin device${result.files_skipped > 0 ? ` (${result.files_skipped} already existed)` : ''}.`;
                    showStatus(message, 'success');
                    loadWorkouts(); // Refresh workout list
                    loadStats(); // Refresh stats
                } else if (result.files_found === 0) {
                    showStatus('No .FIT files found in the Activities folder on your Garmin device.', 'warning');
                } else {
                    showStatus(`Found ${result.files_found} file(s) but couldn't upload any. Check the console for details.`, 'error');
                }

                // Log detailed error information
                if (result.errors && result.errors.length > 0) {
                    console.error('Garmin sync errors:', result.errors);
                }
                
            } catch (error) {
                console.error('Error during Garmin sync:', error);
                showStatus(`Failed to sync with Garmin device: ${error.message}`, 'error');
            } finally {
                // Reset button
                garminBtn.disabled = false;
                garminBtn.innerHTML = originalHTML;
            }
        }

        // Attach Garmin sync handler to button
        document.getElementById('garmin-upload-btn').addEventListener('click', handleGarminSync);

        function showStatus(message, type) {
            // Delegate to the global toast-style notification system
            // Map known types; default to 'info'
            const toastType = (type === 'success' || type === 'error' || type === 'warning') ? type : 'info';
            showNotification(message, toastType);
        }

        // Load and display workouts
        async function loadWorkouts() {
            try {
                const response = await fetch('/api/workouts?limit=10');
                const data = await response.json();
                
                const workoutsList = document.getElementById('workouts-list');
                
                if (data.workouts && data.workouts.length > 0) {
                    workoutsList.innerHTML = '';
                    data.workouts.forEach(workout => {
                        const workoutElement = createWorkoutElement(workout);
                        workoutsList.appendChild(workoutElement);
                    });
                } else {
                    workoutsList.innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400">No workouts found. Upload some FIT files to get started!</div>';
                }
            } catch (error) {
                console.error('Error loading workouts:', error);
                document.getElementById('workouts-list').innerHTML = '<div class="text-center py-8 text-red-500">Error loading workouts.</div>';
            }
        }

        // Load and display statistics
        async function loadMonthlySummary() {
            try {
                const res = await fetch('/api/monthly-summary');
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                // Month range label: use local dates only
                const start = new Date(data.month_start);
                const end = new Date(data.month_end);
                const fmt = (d, opts) => d.toLocaleDateString(undefined, opts);
                const sameMonth = start.getMonth() === new Date(end.getTime() - 24*60*60*1000).getMonth();
                const rangeText = sameMonth
                    ? `${fmt(start, { month: 'long' })} ${start.getFullYear()}`
                    : `${fmt(start, { month: 'short', year: 'numeric' })} - ${fmt(new Date(end.getTime() - 24*60*60*1000), { month: 'short', year: 'numeric' })}`;
                document.getElementById('month-range').textContent = rangeText;

                document.getElementById('monthly-workouts').textContent = data.workouts_count ?? 0;

                const km = (data.total_distance_m || 0) / 1000;
                document.getElementById('monthly-distance').textContent = `${km.toFixed(2)} km`;

                document.getElementById('monthly-duration').textContent = formatDuration(data.total_duration_s || 0);

                document.getElementById('monthly-calories').textContent = `${data.total_calories || 0} kcal`;
            } catch (err) {
                console.error('Error loading monthly summary:', err);
                document.getElementById('month-range').textContent = 'This Month';
                document.getElementById('monthly-workouts').textContent = '—';
                document.getElementById('monthly-distance').textContent = '—';
                document.getElementById('monthly-duration').textContent = '—';
                document.getElementById('monthly-calories').textContent = '—';
            }
        }

        function createWorkoutElement(workout) {
            const div = document.createElement('div');
            // Outer gradient hairline border with hover accent
            div.className = 'group rounded-2xl p-[1px] bg-gradient-to-r from-gray-200/60 via-gray-100/40 to-gray-200/60 dark:from-gray-700/60 dark:via-gray-800/60 dark:to-gray-700/60 hover:from-blue-200/50 hover:via-cyan-200/40 hover:to-emerald-200/50 dark:hover:from-gray-700/80 dark:hover:via-gray-800/80 dark:hover:to-gray-700/80 transition-colors duration-200 cursor-pointer';
            div.onclick = () => showWorkoutDetails(workout.id);
            
            const startTime = workout.start_time ? formatDateForDisplay(workout.start_time) : 'Unknown';
            const duration = workout.duration_seconds ? formatDuration(workout.duration_seconds) : 'Unknown';
            const distance = workout.distance_meters ? (workout.distance_meters / 1000).toFixed(2) + ' km' : 'Unknown';
            const workoutIcon = getWorkoutTypeIcon(workout.workout_type);
            
            div.innerHTML = `
                <div class="rounded-[15px] p-3 bg-white/80 dark:bg-gray-900/40 backdrop-blur-sm">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1 gap-3">
                        <!-- Workout Type Icon -->
                        <div class="flex-shrink-0 w-10 h-10 ${workoutIcon.bgColor} rounded-lg flex items-center justify-center shadow-sm">
                            <div class="${workoutIcon.color}">
                                ${workoutIcon.icon}
                            </div>
                        </div>
                        
                        <!-- Main Content -->
                        <div class="flex-1 min-w-0">
                            <!-- Primary Info: Date and Duration -->
                            <div class="flex items-center gap-2 mb-0.5">
                                <h4 class="text-sm sm:text-base font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">${startTime}</h4>
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold text-blue-700 dark:text-blue-300 bg-white/70 dark:bg-gray-900/40 border border-blue-200/60 dark:border-blue-800/60 backdrop-blur-sm">
                                    ${duration}
                                </span>
                            </div>
                            
                            <!-- Secondary Info: Distance and Activity Type -->
                            <div class="flex items-center gap-2 sm:gap-3 text-xs sm:text-sm text-gray-600 dark:text-gray-300">
                                <span class="font-medium">${distance}</span>
                                <span class="mx-1.5 text-gray-300 dark:text-gray-600 select-none">•</span>
                                <span class="truncate">${formatActivityType(workout.workout_type)}</span>
                            </div>
                            
                            <!-- Filename (less visible) -->
                            <div class="text-[11px] text-gray-400 dark:text-gray-500 truncate mt-0.5 opacity-0 group-hover:opacity-70 transition-opacity duration-200 hidden sm:block">
                                ${workout.filename}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status and Arrow -->
                    <div class="flex items-center gap-2 flex-shrink-0">
                        ${workout.processed ? 
                            '<span class="inline-flex items-center gap-1 text-[10px] font-semibold tracking-wider text-emerald-600 dark:text-emerald-400"><span class="w-2 h-2 rounded-full bg-emerald-500/70"></span><span class="hidden md:inline">Processed</span></span>' : 
                            '<span class="inline-flex items-center gap-1 text-[10px] font-semibold tracking-wider text-amber-600 dark:text-amber-400"><span class="w-2 h-2 rounded-full bg-amber-500/70"></span><span class="hidden md:inline">Processing</span></span>'
                        }
                        <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                  </div>
                </div>
            `;
            
            return div;
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m ${secs}s`;
            }
        }

        // Show workout details modal
        async function showWorkoutDetails(workoutId) {
            const modal = document.getElementById('workout-modal');
            const modalLoading = document.getElementById('modal-loading');
            const modalData = document.getElementById('modal-workout-data');
            
            // Show modal and loading state
            modal.classList.remove('hidden');
            modalLoading.classList.remove('hidden');
            modalData.classList.add('hidden');
            
            try {
                const response = await fetch(`/api/workouts/${workoutId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch workout details');
                }
                
                const workout = await response.json();
                populateWorkoutModal(workout);
                
                // Hide loading, show data
                modalLoading.classList.add('hidden');
                modalData.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading workout details:', error);
                modalLoading.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p>Error loading workout details</p>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        function populateWorkoutModal(workout) {
            // Update modal title
            document.getElementById('modal-title').textContent = `${workout.filename}`;
            
            // Basic Information
            document.getElementById('detail-workout-type').textContent = formatActivityType(workout.workout_type);
            document.getElementById('detail-start-time').textContent = workout.start_time 
                ? formatTimeForDisplay(workout.start_time)
                : 'Unknown';
            document.getElementById('detail-duration').textContent = workout.duration_seconds 
                ? formatDuration(workout.duration_seconds) 
                : 'Unknown';
            document.getElementById('detail-distance').textContent = workout.distance_meters 
                ? `${(workout.distance_meters / 1000).toFixed(2)} km` 
                : 'Unknown';
            
            // Performance Metrics
            document.getElementById('detail-hr-avg').textContent = workout.avg_heart_rate 
                ? `${workout.avg_heart_rate} bpm` 
                : 'N/A';
            document.getElementById('detail-hr-max').textContent = workout.max_heart_rate 
                ? `${workout.max_heart_rate} bpm` 
                : 'N/A';
            
            document.getElementById('detail-power-avg').textContent = workout.avg_power_watts 
                ? `${workout.avg_power_watts} W` 
                : 'N/A';
            document.getElementById('detail-power-max').textContent = workout.max_power_watts 
                ? `${workout.max_power_watts} W` 
                : 'N/A';
            
            document.getElementById('detail-cadence-avg').textContent = workout.avg_cadence 
                ? `${workout.avg_cadence} rpm` 
                : 'N/A';
            document.getElementById('detail-cadence-max').textContent = workout.max_cadence 
                ? `${workout.max_cadence} rpm` 
                : 'N/A';
            
            document.getElementById('detail-speed-avg').textContent = workout.avg_speed_mps 
                ? `${(workout.avg_speed_mps * 3.6).toFixed(1)} km/h` 
                : 'N/A';
            document.getElementById('detail-speed-max').textContent = workout.max_speed_mps 
                ? `${(workout.max_speed_mps * 3.6).toFixed(1)} km/h` 
                : 'N/A';
            
            document.getElementById('detail-calories').textContent = workout.total_calories || 'N/A';
            
            document.getElementById('detail-elevation-gain').textContent = workout.elevation_gain_meters 
                ? `${Math.round(workout.elevation_gain_meters)} m` 
                : 'N/A';
            document.getElementById('detail-elevation-loss').textContent = workout.elevation_loss_meters 
                ? `${Math.round(workout.elevation_loss_meters)} m` 
                : 'N/A';
            
            // File Information
            document.getElementById('detail-filename').textContent = workout.filename || 'Unknown';
            document.getElementById('detail-upload-date').textContent = workout.upload_timestamp 
                ? formatDateForDisplay(workout.upload_timestamp)
                : 'Unknown';
            document.getElementById('detail-status').textContent = workout.processed ? 'Processed' : 'Processing';
            document.getElementById('detail-hash').textContent = workout.file_hash 
                ? workout.file_hash.substring(0, 16) + '...' 
                : 'Unknown';
            
            // Setup charts for this workout
            setupCharts(workout.id);
            
            // Setup delete button for this workout
            setupDeleteButton(workout.id);

            // Setup Folium map iframe (collapsible at top)
            const routeSection = document.getElementById('route-map-section');
            const routeContainer = document.getElementById('route-map-container');
            const iframe = document.getElementById('route-map-iframe');
            const fade = document.getElementById('route-map-fade');
            const toggleBtn = document.getElementById('toggle-map-size');
            const toggleIcon = document.getElementById('toggle-icon');
            const toggleLabel = document.getElementById('toggle-map-label');
            
            // Reset to collapsed state each time modal opens
            routeSection.classList.remove('hidden');
            iframe.style.height = '100%';
            fade.style.opacity = '1';
            toggleBtn.dataset.expanded = 'false';
            toggleIcon.innerHTML = '<path d="M12 5v14m-7-7h14"/>';
            toggleLabel.textContent = 'Expand map';
            
            // Load iframe from folium endpoint with theme
            const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            iframe.src = `/api/workouts/${workout.id}/map/folium?theme=${theme}`;
            
            // Toggle expand/collapse
            // Remove previous listeners by cloning
            const newToggle = toggleBtn.cloneNode(true);
            toggleBtn.parentNode.replaceChild(newToggle, toggleBtn);
            
            newToggle.addEventListener('click', () => {
                const expanded = newToggle.dataset.expanded === 'true';
                if (expanded) {
                    // Collapse back
                    newToggle.dataset.expanded = 'false';
                    document.getElementById('toggle-icon').innerHTML = '<path d="M12 5v14m-7-7h14"/>';
                    document.getElementById('toggle-map-label').textContent = 'Expand map';
                    routeContainer.className = 'relative h-48 md:h-64 bg-gray-100 dark:bg-gray-700';
                    fade.style.opacity = '1';
                } else {
                    // Expand to larger height
                    newToggle.dataset.expanded = 'true';
                    document.getElementById('toggle-icon').innerHTML = '<path d="M18 12H6"/>';
                    document.getElementById('toggle-map-label').textContent = 'Collapse map';
                    routeContainer.className = 'relative h-96 md:h-[32rem] bg-gray-100 dark:bg-gray-700';
                    fade.style.opacity = '0';
                }
            });
        }

        // Chart functionality
        let chartInstances = {};
        
        function setupCharts(workoutId) {
            const chartsContainer = document.getElementById('charts-container');
            const chartsLoading = document.getElementById('charts-loading');
            
            // Show loading state
            chartsLoading.classList.remove('hidden');
            chartsContainer.classList.add('hidden');
            
            // Destroy existing charts
            Object.values(chartInstances).forEach(chart => {
                if (chart) chart.destroy();
            });
            chartInstances = {};

            // Load and display charts automatically
            fetch(`/api/workouts/${workoutId}/chart`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch chart data');
                    }
                    return response.json();
                })
                .then(chartResponse => {
                    const chartData = chartResponse.chart_data;
                    
                    if (chartData && (chartResponse.has_heart_rate || chartResponse.has_speed || chartResponse.has_power || chartResponse.has_cadence)) {
                        createCharts(chartData);
                        chartsLoading.classList.add('hidden');
                        chartsContainer.classList.remove('hidden');
                    } else {
                        throw new Error('No chart data available');
                    }
                })
                .catch(error => {
                    console.error('Error loading chart data:', error);
                    chartsLoading.innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <p>Error loading charts</p>
                            <p class="text-sm">${error.message}</p>
                        </div>
                    `;
                });
        }

        function createCharts(chartData) {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';
            
            // Prepare time labels (every 10th point for readability)
            const timeLabels = chartData.timestamps.map((timestamp, index) => {
                if (index % 10 === 0) {
                    return new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
                return '';
            });
            
            // Chart configuration template
            const baseConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 0
                        }
                    }
                }
            };

            // Heart Rate Chart
            if (chartData.heart_rate.some(hr => hr !== null)) {
                const ctx1 = document.getElementById('heart-rate-chart').getContext('2d');
                chartInstances.heartRate = new Chart(ctx1, {
                    ...baseConfig,
                    data: {
                        labels: timeLabels,
                        datasets: [{
                            label: 'Heart Rate',
                            data: chartData.heart_rate,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            borderWidth: 2,
                            tension: 0.1
                        }]
                    }
                });
            }

            // Speed Chart (convert m/s to km/h)
            if (chartData.speed.some(speed => speed !== null)) {
                const speedKmh = chartData.speed.map(speed => speed ? speed * 3.6 : null);
                const ctx2 = document.getElementById('speed-chart').getContext('2d');
                chartInstances.speed = new Chart(ctx2, {
                    ...baseConfig,
                    data: {
                        labels: timeLabels,
                        datasets: [{
                            label: 'Speed',
                            data: speedKmh,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            borderWidth: 2,
                            tension: 0.1
                        }]
                    }
                });
            }

            // Power Chart
            if (chartData.power.some(power => power !== null)) {
                const ctx3 = document.getElementById('power-chart').getContext('2d');
                chartInstances.power = new Chart(ctx3, {
                    ...baseConfig,
                    data: {
                        labels: timeLabels,
                        datasets: [{
                            label: 'Power',
                            data: chartData.power,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true,
                            borderWidth: 2,
                            tension: 0.1
                        }]
                    }
                });
            }

            // Cadence Chart
            if (chartData.cadence.some(cadence => cadence !== null)) {
                const ctx4 = document.getElementById('cadence-chart').getContext('2d');
                chartInstances.cadence = new Chart(ctx4, {
                    ...baseConfig,
                    data: {
                        labels: timeLabels,
                        datasets: [{
                            label: 'Cadence',
                            data: chartData.cadence,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            borderWidth: 2,
                            tension: 0.1
                        }]
                    }
                });
            }
        }

        // Modal close functionality
        document.getElementById('close-modal').addEventListener('click', closeWorkoutModal);
        document.getElementById('close-modal-footer').addEventListener('click', closeWorkoutModal);
        document.getElementById('workout-modal').addEventListener('click', (e) => {
            if (e.target.id === 'workout-modal') {
                closeWorkoutModal();
            }
        });

        function closeWorkoutModal() {
            document.getElementById('workout-modal').classList.add('hidden');
        }

        // Delete workout functionality
        let currentWorkoutId = null;
        
        function setupDeleteButton(workoutId) {
            currentWorkoutId = workoutId;
            const deleteBtn = document.getElementById('delete-workout-btn');
            
            // Remove existing event listeners
            const newDeleteBtn = deleteBtn.cloneNode(true);
            deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
            
            newDeleteBtn.addEventListener('click', async () => {
                const confirmed = confirm('Are you sure you want to delete this workout? This action cannot be undone and will remove all associated files.');
                
                if (confirmed) {
                    try {
                        newDeleteBtn.disabled = true;
                        newDeleteBtn.innerHTML = `
                            <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                                <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path>
                            </svg>
                            Deleting...
                        `;
                        
                        const response = await fetch(`/api/workouts/${workoutId}`, {
                            method: 'DELETE'
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to delete workout');
                        }
                        
                        const result = await response.json();
                        
                        // Close modal
                        closeWorkoutModal();
                        
                        // Show success message
                        showNotification('Workout deleted successfully', 'success');
                        
                        // Refresh the workouts list
                        await loadWorkouts();
                        
                    } catch (error) {
                        console.error('Error deleting workout:', error);
                        showNotification(`Error deleting workout: ${error.message}`, 'error');
                        
                        // Reset button
                        newDeleteBtn.disabled = false;
                        newDeleteBtn.innerHTML = `
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Delete Workout
                        `;
                    }
                }
            });
        }

        // Notification system
    function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 max-w-sm w-full px-4 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
                type === 'success' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 border border-green-200 dark:border-green-700' :
                type === 'error' ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 border border-red-200 dark:border-red-700' :
                type === 'warning' ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 border border-yellow-200 dark:border-yellow-700' :
                'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 border border-blue-200 dark:border-blue-700'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        ${type === 'success' ? `
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        ` : type === 'error' ? `
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        ` : type === 'warning' ? `
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.93 19h14.14c1.54 0 2.5-1.67 1.73-3L13.73 5c-.77-1.33-2.69-1.33-3.46 0L3.2 16c-.77 1.33 .19 3 1.73 3z"></path>
                            </svg>
                        ` : `
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        `}
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <div class="ml-4 flex-shrink-0">
                        <button class="text-current hover:opacity-75" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            // Add to document
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeWorkoutModal();
            }
        });

        // Refresh workouts button
        document.getElementById('refresh-workouts').addEventListener('click', loadWorkouts);

    // Load workouts and monthly summary on page load
    loadWorkouts();
    loadMonthlySummary();

        // Drag and drop functionality
        const dropZone = document.querySelector('main');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('ring-2', 'ring-primary-500', 'ring-inset', 'bg-primary-50/50', 'dark:bg-primary-900/20');
        }

        function unhighlight(e) {
            dropZone.classList.remove('ring-2', 'ring-primary-500', 'ring-inset', 'bg-primary-50/50', 'dark:bg-primary-900/20');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            fileInput.files = files;
            handleFileSelection({ target: { files: files } });
        }
    </script>
</body>
</html>
